<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Relatório Fotográfico Ambiental 3.3</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            line-height: 1.6;
        }
        .container {
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 5px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }
        .header {
            text-align: center;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #006400;
        }
        h1, h2 {
            color: #006400;
        }
        .form-section {
            margin-bottom: 25px;
            page-break-inside: avoid;
            break-inside: avoid;
        }
        .form-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            font-weight: bold;
            margin-bottom: 5px;
        }
        input, textarea, select {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
        }
        #map {
            height: 400px;
            width: 100%;
            margin: 15px 0;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .btn {
            background-color: #006400;
            color: white;
            padding: 10px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin-top: 10px;
        }
        .btn-secondary {
            background-color: #6c757d;
        }
        .btn-danger {
            background-color: #dc3545;
        }
        .coordinates {
            display: flex;
            gap: 15px;
        }
        .coord-input {
            flex: 1;
        }
        .error {
            color: red;
            margin-top: 5px;
        }
        .photo-container {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-top: 15px;
            page-break-inside: avoid;
            break-inside: avoid;
        }
        .photo-item {
            flex: 1 1 300px;
            border: 1px solid #ddd;
            padding: 10px;
            border-radius: 5px;
            position: relative;
            page-break-inside: avoid;
            break-inside: avoid;
        }
        .photo-number {
            position: absolute;
            top: 5px;
            left: 5px;
            background-color: rgba(0, 100, 0, 0.7);
            color: white;
            padding: 3px 8px;
            border-radius: 3px;
            font-weight: bold;
        }
        .photo-preview {
            width: 100%;
            height: 200px;
            object-fit: cover;
            background-color: #f5f5f5;
            margin-bottom: 10px;
        }
        .datetime-group {
            display: flex;
            gap: 15px;
        }
        .datetime-input {
            flex: 1;
        }
        .dms-coordinates {
            font-family: monospace;
            background-color: #f5f5f5;
            padding: 5px;
            border-radius: 3px;
        }
        .action-buttons {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 20px;
        }
        .connection-status {
            position: fixed;
            top: 10px;
            right: 10px;
            padding: 5px 10px;
            border-radius: 4px;
            color: white;
            font-weight: bold;
            z-index: 1000;
        }
        .online {
            background-color: #28a745;
        }
        .offline {
            background-color: #dc3545;
        }
        .footer {
            text-align: center;
            margin-top: 30px;
            padding-top: 15px;
            border-top: 1px solid #ddd;
            font-size: 0.9em;
            color: #666;
        }
        .termo-item, .auto-item {
            border: 1px solid #ddd;
            padding: 10px;
            margin-bottom: 10px;
            border-radius: 4px;
            page-break-inside: avoid;
            break-inside: avoid;
        }
        .add-btn {
            margin-bottom: 15px;
        }
        #signature-pad {
            border: 1px solid #ddd;
            border-radius: 4px;
            background-color: white;
        }
        .signature-clear {
            margin-top: 10px;
        }
        #qrcode {
            margin: 15px 0;
            text-align: center;
        }
        .alert-warning {
            display: none;
            padding: 10px;
            background: #fff3cd;
            margin-bottom: 15px;
            border-radius: 4px;
        }
        .page-break {
            page-break-after: always;
            break-after: page;
        }
        .avoid-break {
            page-break-inside: avoid;
            break-inside: avoid;
        }
        .coord-source {
            font-size: 0.8em;
            color: #666;
            font-style: italic;
        }
        
        /* Estilos específicos para impressão/PDF */
        @media print {
            .no-print {
                display: none !important;
            }
            body {
                margin: 0;
                padding: 0;
                font-size: 12pt;
                line-height: 1.3;
            }
            .container {
                max-width: 100%;
                border: none;
                box-shadow: none;
                padding: 0;
            }
            .header {
                margin-bottom: 15pt;
                padding-bottom: 5pt;
            }
            h1 {
                font-size: 18pt;
                margin-bottom: 10pt;
            }
            h2 {
                font-size: 14pt;
                margin-top: 15pt;
                margin-bottom: 8pt;
            }
            .form-section {
                margin-bottom: 20pt;
            }
            .photo-item {
                page-break-inside: avoid;
                margin-bottom: 15pt;
            }
            .photo-preview {
                max-height: 250pt;
                height: auto;
            }
            #signature-pad {
                width: 100% !important;
                height: 80pt !important;
            }
            .footer {
                display: none;
            }
            
            /* Cabeçalho e rodapé das páginas */
            @page {
                size: A4;
                margin: 2cm 1.5cm 2cm 1.5cm;
                
                @top-center {
                    content: "Relatório Fotográfico Ambiental - ICMBio";
                    font-size: 10pt;
                    border-bottom: 1px solid #006400;
                    padding-bottom: 5pt;
                }
                
                @bottom-center {
                    content: "Página " counter(page) " de " counter(pages);
                    font-size: 10pt;
                    border-top: 1px solid #006400;
                    padding-top: 5pt;
                }
            }
        }
    </style>
</head>
<body>
    <div id="connectionStatus" class="connection-status offline">Offline</div>
    <div id="storage-warning" class="alert-warning">
        Atenção: O armazenamento está quase cheio. Alguns dados podem não ser salvos.
    </div>
    
    <div class="container" id="relatorio">
        <div class="header">
            <h1>Relatório Fotográfico Ambiental - Versão 3.3</h1>
            <p>Instituto Chico Mendes de Conservação da Biodiversidade - ICMBio</p>
            <div id="qrcode"></div>
        </div>
        
        <div class="form-section">
            <h2>Dados do Relatório</h2>
            
            <div class="datetime-group">
                <div class="datetime-input">
                    <label for="data">Data:</label>
                    <input type="date" id="data" required>
                </div>
                <div class="datetime-input">
                    <label for="hora">Hora:</label>
                    <input type="time" id="hora" required>
                </div>
            </div>
            
            <div class="form-group">
                <label for="local">Local da Fiscalização:</label>
                <input type="text" id="local" required>
            </div>
            
            <div class="form-group">
                <label for="infrator_nome">Nome do Infrator:</label>
                <input type="text" id="infrator_nome" required>
            </div>
            
            <div class="form-group">
                <label for="infrator_documento">CPF/CNPJ:</label>
                <input type="text" id="infrator_documento" required>
            </div>
            
            <div class="form-group">
                <label>Coordenadas Geográficas (Graus Decimais):</label>
                <div class="coordinates">
                    <input type="text" id="latitude" class="coord-input" placeholder="Latitude" readonly>
                    <input type="text" id="longitude" class="coord-input" placeholder="Longitude" readonly>
                </div>
                <div id="coord-error" class="error"></div>
                <div class="form-group">
                    <input type="checkbox" id="rastreamento" checked>
                    <label for="rastreamento" style="display: inline;">Atualizar coordenadas automaticamente</label>
                </div>
            </div>
            
            <div class="form-group">
                <label>Coordenadas em Graus, Minutos e Segundos:</label>
                <div id="dms-coordinates" class="dms-coordinates">Não disponível</div>
            </div>
            
            <div class="buttons no-print">
                <button id="get-location" class="btn">Obter Localização Atual</button>
                <button id="manual-coords" class="btn btn-secondary">Inserir Coordenadas Manualmente</button>
            </div>
            
            <div id="map"></div>
        </div>
        
        <div class="form-section">
            <h2>Autos de Infração</h2>
            <div id="autos-container">
                <div class="auto-item">
                    <div class="form-group">
                        <label for="auto_numero_1">Número do Auto de Infração:</label>
                        <input type="text" id="auto_numero_1" class="auto-numero" required>
                    </div>
                    <div class="form-group">
                        <label for="auto_descricao_1">Descrição da Infração:</label>
                        <textarea id="auto_descricao_1" class="auto-descricao" rows="3" required></textarea>
                    </div>
                </div>
            </div>
            <button id="add-auto" class="btn btn-secondary add-btn no-print">Adicionar outro Auto</button>
        </div>
        
        <div class="form-section">
            <h2>Termos</h2>
            <div id="termos-container">
                <div class="termo-item">
                    <div class="form-group">
                        <label for="termo_tipo_1">Tipo de Termo:</label>
                        <select id="termo_tipo_1" class="termo-tipo" required>
                            <option value="">Selecione...</option>
                            <option value="notificacao">Termo de Notificação</option>
                            <option value="apreensao">Termo de Apreensão</option>
                            <option value="embargo">Termo de Embargo</option>
                            <option value="soltura">Termo de Soltura</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="termo_numero_1">Número do Termo:</label>
                        <input type="text" id="termo_numero_1" class="termo-numero" required>
                    </div>
                </div>
            </div>
            <button id="add-termo" class="btn btn-secondary add-btn no-print">Adicionar outro Termo</button>
        </div>
        
        <div class="form-section">
            <h2>Descrição da Ação</h2>
            <div class="form-group">
                <label for="descricao">Descrição detalhada do que foi realizado em campo:</label>
                <textarea id="descricao" rows="6" required></textarea>
            </div>
        </div>
        
        <div class="form-section">
            <h2>Registro Fotográfico</h2>
            
            <div class="form-group no-print">
                <label for="photo-upload">Adicionar Fotos:</label>
                <input type="file" id="photo-upload" accept="image/*" multiple>
                <small>Selecione uma ou mais fotos para upload (com geolocalização preferencialmente)</small>
            </div>
            
            <div id="photo-container" class="photo-container">
                <!-- Template para novas fotos -->
                <div class="photo-item" style="display: none;">
                    <div class="photo-number">Figura 1</div>
                    <img class="photo-preview" src="">
                    <div class="form-group">
                        <label>Legenda:</label>
                        <input type="text" class="photo-caption" placeholder="Descreva a foto">
                    </div>
                    <div class="form-group">
                        <label>Coordenadas:</label>
                        <input type="text" class="photo-coords" readonly>
                        <div class="coord-source"></div>
                    </div>
                    <button class="btn btn-secondary remove-photo no-print">Remover</button>
                </div>
            </div>
        </div>
        
        <div class="form-section">
            <h2>Assinatura do Fiscal</h2>
            <div class="form-group">
                <label for="fiscal_nome">Nome do Fiscal:</label>
                <input type="text" id="fiscal_nome" required>
            </div>
            <div class="form-group">
                <label for="fiscal_matricula">Matrícula:</label>
                <input type="text" id="fiscal_matricula" required>
            </div>
            <div class="form-group">
                <label>Assinatura:</label>
                <canvas id="signature-pad" width="400" height="200"></canvas>
                <button id="clear-signature" class="btn btn-secondary signature-clear no-print">Limpar Assinatura</button>
            </div>
        </div>
        
        <div class="action-buttons no-print">
            <button id="print-report" class="btn">Imprimir Relatório</button>
            <button id="generate-pdf" class="btn btn-secondary">Gerar PDF</button>
            <button id="save-data" class="btn btn-secondary">Salvar Dados</button>
            <button id="load-data" class="btn btn-secondary">Carregar Dados</button>
            <button id="clear-storage" class="btn btn-danger">Limpar Armazenamento</button>
        </div>
        
        <div class="footer">
            <p>Todos os direitos reservados &copy; <span id="current-year"></span> - Iram Mendes Jr - Analista Ambiental - ICMBio</p>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/signature_pad/1.5.3/signature_pad.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.1/build/qrcode.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/exif-js"></script>
    
    <script>
        // Variáveis globais
        let map;
        let marker;
        let signaturePad;
        let watchPositionId = null;
        let autoCount = 1;
        let termoCount = 1;
        let photoCount = 0;
        let isOnline = navigator.onLine;
        
        // Inicialização
        document.addEventListener('DOMContentLoaded', function() {
            // Configura data e hora atuais
            const now = new Date();
            document.getElementById('data').value = now.toISOString().split('T')[0];
            document.getElementById('hora').value = now.toTimeString().substring(0, 5);
            document.getElementById('current-year').textContent = now.getFullYear();
            
            // Inicializa o mapa
            initMap(-15.788, -47.879);
            
            // Inicializa a área de assinatura
            const canvas = document.getElementById('signature-pad');
            signaturePad = new SignaturePad(canvas);
            
            // Configura eventos
            setupEventListeners();
            
            // Atualiza status da conexão
            updateConnectionStatus();
            
            // Gera QR Code inicial
            generateQRCode();
            
            // Verifica espaço de armazenamento
            checkStorageSpace();
        });
        
        // Configura os listeners de eventos
        function setupEventListeners() {
            // Botões de localização
            document.getElementById('get-location').addEventListener('click', getLocation);
            document.getElementById('manual-coords').addEventListener('click', manualCoords);
            
            // Botões de formulário
            document.getElementById('add-auto').addEventListener('click', addAuto);
            document.getElementById('add-termo').addEventListener('click', addTermo);
            
            // Upload de fotos
            document.getElementById('photo-upload').addEventListener('change', handlePhotoUpload);
            
            // Ações principais
            document.getElementById('print-report').addEventListener('click', printReport);
            document.getElementById('generate-pdf').addEventListener('click', generatePDF);
            document.getElementById('save-data').addEventListener('click', saveData);
            document.getElementById('load-data').addEventListener('click', loadData);
            document.getElementById('clear-signature').addEventListener('click', clearSignature);
            document.getElementById('clear-storage').addEventListener('click', clearStorage);
            
            // Monitora mudanças na conexão
            window.addEventListener('online', updateConnectionStatus);
            window.addEventListener('offline', updateConnectionStatus);
        }
        
        // Inicializa o mapa
        function initMap(lat, lng) {
            if (map) {
                map.setView([lat, lng], 15);
                if (marker) {
                    marker.setLatLng([lat, lng]);
                }
                return;
            }
            
            map = L.map('map').setView([lat, lng], 15);
            
            // Camadas base
            const streetLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            });
            
            const satelliteLayer = L.tileLayer('https://mt1.google.com/vt/lyrs=s&x={x}&y={y}&z={z}', {
                attribution: 'Imagens © Google Satellite'
            });
            
            // Adiciona camada padrão
            if (isOnline) {
                satelliteLayer.addTo(map);
            } else {
                document.getElementById('map').innerHTML = 
                    '<p style="text-align: center; padding-top: 180px;">Mapa offline não disponível. Conecte-se à internet para carregar mapas.</p>';
            }
            
            // Adiciona marcador
            marker = L.marker([lat, lng], { draggable: true }).addTo(map);
            
            // Atualiza coordenadas quando o marcador é movido
            marker.on('dragend', function() {
                const newLatLng = marker.getLatLng();
                updateCoordinates(newLatLng.lat, newLatLng.lng);
            });
            
            // Atualiza coordenadas quando clica no mapa
            map.on('click', function(e) {
                updateCoordinates(e.latlng.lat, e.latlng.lng);
                if (!marker) {
                    marker = L.marker(e.latlng, { draggable: true }).addTo(map);
                    marker.on('dragend', function() {
                        const newLatLng = marker.getLatLng();
                        updateCoordinates(newLatLng.lat, newLatLng.lng);
                    });
                } else {
                    marker.setLatLng(e.latlng);
                }
            });
        }
        
        // Obtém a localização atual
        function getLocation() {
            const coordError = document.getElementById('coord-error');
            coordError.textContent = 'Obtendo localização...';
            
            if (!navigator.geolocation) {
                coordError.textContent = 'Geolocalização não é suportada pelo seu navegador';
                return;
            }
            
            // Para qualquer rastreamento anterior
            if (watchPositionId) {
                navigator.geolocation.clearWatch(watchPositionId);
            }
            
            const rastreamentoAtivo = document.getElementById('rastreamento').checked;
            
            if (rastreamentoAtivo) {
                // Rastreamento contínuo
                watchPositionId = navigator.geolocation.watchPosition(
                    position => {
                        const lat = position.coords.latitude;
                        const lng = position.coords.longitude;
                        updateCoordinates(lat, lng);
                        initMap(lat, lng);
                        coordError.textContent = 'Rastreamento ativo - coordenadas atualizadas';
                    },
                    error => {
                        handleGeolocationError(error);
                    },
                    { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
                );
            } else {
                // Única leitura
                navigator.geolocation.getCurrentPosition(
                    position => {
                        const lat = position.coords.latitude;
                        const lng = position.coords.longitude;
                        updateCoordinates(lat, lng);
                        initMap(lat, lng);
                        coordError.textContent = '';
                    },
                    error => {
                        handleGeolocationError(error);
                    },
                    { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
                );
            }
        }
        
        // Trata erros de geolocalização
        function handleGeolocationError(error) {
            const coordError = document.getElementById('coord-error');
            let errorMessage;
            
            switch(error.code) {
                case error.PERMISSION_DENIED:
                    errorMessage = "Permissão de localização negada pelo usuário";
                    break;
                case error.POSITION_UNAVAILABLE:
                    errorMessage = "Informações de localização indisponíveis";
                    break;
                case error.TIMEOUT:
                    errorMessage = "Tempo limite para obter localização excedido";
                    break;
                default:
                    errorMessage = "Ocorreu um erro desconhecido";
            }
            
            coordError.textContent = "Erro: " + errorMessage;
        }
        
        // Permite inserir coordenadas manualmente
        function manualCoords() {
            const lat = prompt("Digite a latitude (ex: -15.788):");
            const lng = prompt("Digite a longitude (ex: -47.879):");
            
            if (lat && lng && !isNaN(lat) && !isNaN(lng)) {
                updateCoordinates(parseFloat(lat), parseFloat(lng));
                initMap(parseFloat(lat), parseFloat(lng));
            } else {
                alert("Coordenadas inválidas. Por favor, insira valores numéricos.");
            }
        }
        
        // Atualiza os campos de coordenadas
        function updateCoordinates(lat, lng) {
            document.getElementById('latitude').value = lat.toFixed(6);
            document.getElementById('longitude').value = lng.toFixed(6);
            updateDMSCoordinates(lat, lng);
            document.getElementById('coord-error').textContent = '';
        }
        
        // Converte para graus, minutos e segundos
        function decimalToDMS(decimal, isLatitude) {
            const absDecimal = Math.abs(decimal);
            const degrees = Math.floor(absDecimal);
            const minutesNotTruncated = (absDecimal - degrees) * 60;
            const minutes = Math.floor(minutesNotTruncated);
            const seconds = ((minutesNotTruncated - minutes) * 60).toFixed(2);
            
            const direction = isLatitude 
                ? (decimal >= 0 ? 'N' : 'S') 
                : (decimal >= 0 ? 'E' : 'W');
            
            return `${degrees}° ${minutes}' ${seconds}" ${direction}`;
        }
        
        // Atualiza as coordenadas DMS
        function updateDMSCoordinates(lat, lng) {
            const latDMS = decimalToDMS(lat, true);
            const lngDMS = decimalToDMS(lng, false);
            document.getElementById('dms-coordinates').textContent = 
                `Latitude: ${latDMS} | Longitude: ${lngDMS}`;
        }
        
        // Adiciona um novo auto de infração
        function addAuto() {
            autoCount++;
            const newAuto = document.createElement('div');
            newAuto.className = 'auto-item';
            newAuto.innerHTML = `
                <div class="form-group">
                    <label for="auto_numero_${autoCount}">Número do Auto de Infração:</label>
                    <input type="text" id="auto_numero_${autoCount}" class="auto-numero" required>
                </div>
                <div class="form-group">
                    <label for="auto_descricao_${autoCount}">Descrição da Infração:</label>
                    <textarea id="auto_descricao_${autoCount}" class="auto-descricao" rows="3" required></textarea>
                </div>
                <button class="btn btn-secondary remove-auto no-print" data-id="${autoCount}">Remover Auto</button>
            `;
            document.getElementById('autos-container').appendChild(newAuto);
            
            // Adiciona evento para remover o auto
            newAuto.querySelector('.remove-auto').addEventListener('click', function() {
                if (autoCount > 1) {
                    document.getElementById('autos-container').removeChild(newAuto);
                    autoCount--;
                } else {
                    alert("Pelo menos um auto de infração deve ser mantido.");
                }
            });
        }
        
        // Adiciona um novo termo
        function addTermo() {
            termoCount++;
            const newTermo = document.createElement('div');
            newTermo.className = 'termo-item';
            newTermo.innerHTML = `
                <div class="form-group">
                    <label for="termo_tipo_${termoCount}">Tipo de Termo:</label>
                    <select id="termo_tipo_${termoCount}" class="termo-tipo" required>
                        <option value="">Selecione...</option>
                        <option value="notificacao">Termo de Notificação</option>
                        <option value="apreensao">Termo de Apreensão</option>
                        <option value="embargo">Termo de Embargo</option>
                        <option value="soltura">Termo de Soltura</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="termo_numero_${termoCount}">Número do Termo:</label>
                    <input type="text" id="termo_numero_${termoCount}" class="termo-numero" required>
                </div>
                <button class="btn btn-secondary remove-termo no-print" data-id="${termoCount}">Remover Termo</button>
            `;
            document.getElementById('termos-container').appendChild(newTermo);
            
            // Adiciona evento para remover o termo
            newTermo.querySelector('.remove-termo').addEventListener('click', function() {
                if (termoCount > 1) {
                    document.getElementById('termos-container').removeChild(newTermo);
                    termoCount--;
                } else {
                    alert("Pelo menos um termo deve ser mantido.");
                }
            });
        }
        
        // Manipula o upload de fotos
        function handlePhotoUpload(e) {
            const files = e.target.files;
            const defaultCoords = {
                lat: parseFloat(document.getElementById('latitude').value) || -15.788,
                lng: parseFloat(document.getElementById('longitude').value) || -47.879,
                fromExif: false
            };
            
            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                
                if (file.type.match('image.*')) {
                    const reader = new FileReader();
                    
                    reader.onload = function(e) {
                        EXIF.getData(file, function() {
                            const exifData = EXIF.getAllTags(this);
                            let coords = {...defaultCoords};
                            
                            if (exifData.GPSLatitude && exifData.GPSLongitude) {
                                coords = {
                                    lat: convertDMSToDD(
                                        exifData.GPSLatitude[0],
                                        exifData.GPSLatitude[1],
                                        exifData.GPSLatitude[2],
                                        exifData.GPSLatitudeRef
                                    ),
                                    lng: convertDMSToDD(
                                        exifData.GPSLongitude[0],
                                        exifData.GPSLongitude[1],
                                        exifData.GPSLongitude[2],
                                        exifData.GPSLongitudeRef
                                    ),
                                    fromExif: true
                                };
                            }
                            
                            addPhoto(file, coords);
                        });
                    };
                    reader.readAsDataURL(file);
                } else {
                    addPhoto(file, defaultCoords);
                }
            }
            
            e.target.value = '';
        }

        // Converte DMS para DD (graus decimais)
        function convertDMSToDD(degrees, minutes, seconds, direction) {
            let dd = Number(degrees) + (Number(minutes) / 60) + (Number(seconds) / 3600);
            if (direction === 'S' || direction === 'W') {
                dd = dd * -1;
            }
            return dd;
        }
        
        // Adiciona uma foto ao relatório
        function addPhoto(file, coords) {
            photoCount++;
            const photoContainer = document.getElementById('photo-container');
            const template = photoContainer.querySelector('.photo-item');
            const newPhoto = template.cloneNode(true);
            
            newPhoto.style.display = 'block';
            newPhoto.querySelector('.photo-number').textContent = `Figura ${photoCount}`;
            newPhoto.querySelector('.photo-preview').src = URL.createObjectURL(file);
            
            const coordSource = coords.fromExif ? 
                '(Coordenadas extraídas da foto)' : 
                '(Coordenadas do formulário)';
            
            newPhoto.querySelector('.photo-coords').value = 
                `${coords.lat.toFixed(6)}, ${coords.lng.toFixed(6)}`;
            newPhoto.querySelector('.coord-source').textContent = coordSource;
            
            newPhoto.querySelector('.photo-caption').placeholder = "Descreva a foto...";
            
            newPhoto.querySelector('.remove-photo').addEventListener('click', function() {
                photoContainer.removeChild(newPhoto);
                updatePhotoNumbers();
            });
            
            photoContainer.appendChild(newPhoto);
        }
        
        // Atualiza a numeração das fotos
        function updatePhotoNumbers() {
            const photos = document.querySelectorAll('.photo-item:not([style*="display: none"])');
            photoCount = 0;
            
            photos.forEach((photo, index) => {
                photoCount++;
                photo.querySelector('.photo-number').textContent = `Figura ${photoCount}`;
            });
        }
        
        // Limpa a assinatura
        function clearSignature() {
            signaturePad.clear();
        }
        
        // Limpa o armazenamento
        function clearStorage() {
            if (confirm('Tem certeza que deseja limpar todos os dados salvos?')) {
                localStorage.clear();
                alert('Armazenamento limpo com sucesso!');
                document.getElementById('storage-warning').style.display = 'none';
            }
        }
        
        // Imprime o relatório
        function printReport() {
            window.print();
        }
        
        // Verifica o espaço disponível no localStorage
        function checkStorageSpace() {
            try {
                // Testa o armazenamento tentando salvar dados
                const testKey = 'storage_test';
                let data = '';
                for (let i = 0; i < 1024; i++) {
                    data += '1234567890'; // 10KB
                }
                
                localStorage.setItem(testKey, data);
                localStorage.removeItem(testKey);
                document.getElementById('storage-warning').style.display = 'none';
                return true;
            } catch (e) {
                if (e.name === 'QuotaExceededError') {
                    document.getElementById('storage-warning').style.display = 'block';
                    return false;
                }
                return true;
            }
        }
        
        // Gera PDF com paginação melhorada
        function generatePDF() {
            if (!checkStorageSpace()) {
                alert('Não é possível gerar PDF com armazenamento cheio.');
                return;
            }

            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('p', 'pt', 'a4');
            const element = document.getElementById('relatorio');
            const padding = 40;
            const pageWidth = doc.internal.pageSize.getWidth() - padding * 2;
            const pageHeight = doc.internal.pageSize.getHeight() - padding - 40; // Espaço para cabeçalho/rodapé
            
            // Mostra mensagem de processamento
            const loadingMessage = document.createElement('div');
            loadingMessage.style.position = 'fixed';
            loadingMessage.style.top = '50%';
            loadingMessage.style.left = '50%';
            loadingMessage.style.transform = 'translate(-50%, -50%)';
            loadingMessage.style.backgroundColor = 'rgba(0,0,0,0.7)';
            loadingMessage.style.color = 'white';
            loadingMessage.style.padding = '20px';
            loadingMessage.style.borderRadius = '5px';
            loadingMessage.style.zIndex = '9999';
            loadingMessage.textContent = 'Gerando PDF, por favor aguarde...';
            document.body.appendChild(loadingMessage);
            
            // Divide o relatório em seções lógicas para melhor paginação
            const sections = [
                {
                    title: "Dados do Relatório",
                    selector: ".form-section:nth-child(2)"
                },
                {
                    title: "Autos de Infração",
                    selector: ".form-section:nth-child(3)"
                },
                {
                    title: "Termos",
                    selector: ".form-section:nth-child(4)"
                },
                {
                    title: "Descrição da Ação",
                    selector: ".form-section:nth-child(5)"
                },
                {
                    title: "Registro Fotográfico",
                    selector: ".form-section:nth-child(6)",
                    isPhotoSection: true
                },
                {
                    title: "Assinatura do Fiscal",
                    selector: ".form-section:nth-child(7)"
                }
            ];
            
            let currentPage = 1;
            
            // Função para adicionar cabeçalho
            const addHeader = (doc, title, pageNumber, totalPages) => {
                doc.setFontSize(14);
                doc.setTextColor(0, 100, 0);
                doc.text(title, padding, padding - 10);
                doc.setFontSize(10);
                doc.setTextColor(0, 0, 0);
                doc.text(`Página ${pageNumber} de ${totalPages}`, doc.internal.pageSize.getWidth() - padding - 50, padding - 10);
                
                // Linha divisória
                doc.setDrawColor(0, 100, 0);
                doc.setLineWidth(0.5);
                doc.line(padding, padding, doc.internal.pageSize.getWidth() - padding, padding);
            };
            
            // Processa cada seção sequencialmente
            const processSection = (index) => {
                if (index >= sections.length) {
                    // Remove a mensagem de carregamento
                    document.body.removeChild(loadingMessage);
                    
                    // Salva o PDF
                    doc.save('relatorio_ambiental.pdf');
                    return;
                }
                
                const section = sections[index];
                const sectionElement = document.querySelector(section.selector);
                
                html2canvas(sectionElement, {
                    scale: 2,
                    logging: false,
                    useCORS: true,
                    backgroundColor: '#FFFFFF',
                    allowTaint: true
                }).then(canvas => {
                    const imgData = canvas.toDataURL('image/png');
                    const imgWidth = pageWidth;
                    const imgHeight = (canvas.height * imgWidth) / canvas.width;
                    
                    // Verifica se precisa de nova página
                    if (currentPage > 1 || (index > 0 && doc.autoTableEndPosY() + imgHeight > pageHeight)) {
                        doc.addPage();
                        currentPage++;
                    }
                    
                    // Adiciona cabeçalho
                    addHeader(doc, section.title, currentPage, sections.length);
                    
                    // Calcula posição Y inicial (após cabeçalho)
                    const startY = padding + 20;
                    
                    // Adiciona a imagem ao PDF
                    doc.addImage(imgData, 'PNG', padding, startY, imgWidth, imgHeight);
                    
                    // Processa próxima seção
                    processSection(index + 1);
                }).catch(error => {
                    document.body.removeChild(loadingMessage);
                    alert('Erro ao gerar PDF: ' + error.message);
                });
            };
            
            // Inicia o processamento
            processSection(0);
        }
        
        // Salva os dados no localStorage
        function saveData() {
            if (!validateForm()) {
                alert('Por favor, preencha todos os campos obrigatórios antes de salvar.');
                return;
            }
            
            if (!checkStorageSpace()) {
                alert('Armazenamento cheio. Não é possível salvar os dados.');
                return;
            }
            
            const reportData = {
                data: document.getElementById('data').value,
                hora: document.getElementById('hora').value,
                local: document.getElementById('local').value,
                infrator_nome: document.getElementById('infrator_nome').value,
                infrator_documento: document.getElementById('infrator_documento').value,
                latitude: document.getElementById('latitude').value,
                longitude: document.getElementById('longitude').value,
                descricao: document.getElementById('descricao').value,
                fiscal_nome: document.getElementById('fiscal_nome').value,
                fiscal_matricula: document.getElementById('fiscal_matricula').value,
                signature: signaturePad.isEmpty() ? null : signaturePad.toDataURL('image/png'),
                autos: [],
                termos: [],
                photos: []
            };
            
            // Coleta dados dos autos
            document.querySelectorAll('.auto-item').forEach((auto, index) => {
                const autoId = index + 1;
                reportData.autos.push({
                    numero: document.getElementById(`auto_numero_${autoId}`).value,
                    descricao: document.getElementById(`auto_descricao_${autoId}`).value
                });
            });
            
            // Coleta dados dos termos
            document.querySelectorAll('.termo-item').forEach((termo, index) => {
                const termoId = index + 1;
                reportData.termos.push({
                    tipo: document.getElementById(`termo_tipo_${termoId}`).value,
                    numero: document.getElementById(`termo_numero_${termoId}`).value
                });
            });
            
            // Coleta dados das fotos
            document.querySelectorAll('.photo-item:not([style*="display: none"])').forEach(photo => {
                reportData.photos.push({
                    caption: photo.querySelector('.photo-caption').value,
                    coords: photo.querySelector('.photo-coords').value,
                    src: photo.querySelector('.photo-preview').src,
                    coordSource: photo.querySelector('.coord-source').textContent
                });
            });
            
            try {
                localStorage.setItem('ambientalReportData', JSON.stringify(reportData));
                alert('Dados salvos com sucesso!');
                
                // Atualiza o QRCode com os dados atuais
                generateQRCode();
            } catch (e) {
                if (e.name === 'QuotaExceededError') {
                    alert('O armazenamento está cheio. Não foi possível salvar os dados.');
                } else {
                    alert('Erro ao salvar dados: ' + e.message);
                }
            }
        }
        
        // Carrega os dados do localStorage
        function loadData() {
            const savedData = localStorage.getItem('ambientalReportData');
            if (!savedData) {
                alert('Nenhum dado salvo encontrado.');
                return;
            }
            
            try {
                const reportData = JSON.parse(savedData);
                
                // Limpa os containers antes de carregar novos dados
                document.getElementById('autos-container').innerHTML = '';
                document.getElementById('termos-container').innerHTML = '';
                document.getElementById('photo-container').innerHTML = '';
                
                // Reinicia os contadores
                autoCount = 0;
                termoCount = 0;
                photoCount = 0;
                
                // Carrega dados básicos
                document.getElementById('data').value = reportData.data || '';
                document.getElementById('hora').value = reportData.hora || '';
                document.getElementById('local').value = reportData.local || '';
                document.getElementById('infrator_nome').value = reportData.infrator_nome || '';
                document.getElementById('infrator_documento').value = reportData.infrator_documento || '';
                document.getElementById('latitude').value = reportData.latitude || '';
                document.getElementById('longitude').value = reportData.longitude || '';
                document.getElementById('descricao').value = reportData.descricao || '';
                document.getElementById('fiscal_nome').value = reportData.fiscal_nome || '';
                document.getElementById('fiscal_matricula').value = reportData.fiscal_matricula || '';
                
                if (reportData.signature) {
                    signaturePad.fromDataURL(reportData.signature);
                }
                
                if (reportData.latitude && reportData.longitude) {
                    updateDMSCoordinates(
                        parseFloat(reportData.latitude),
                        parseFloat(reportData.longitude)
                    );
                    
                    initMap(
                        parseFloat(reportData.latitude),
                        parseFloat(reportData.longitude)
                    );
                }
                
                // Carrega autos de infração
                if (reportData.autos && reportData.autos.length > 0) {
                    reportData.autos.forEach((auto, index) => {
                        if (index === 0) {
                            // Usa o primeiro auto que já existe
                            document.getElementById('auto_numero_1').value = auto.numero || '';
                            document.getElementById('auto_descricao_1').value = auto.descricao || '';
                            autoCount = 1;
                        } else {
                            // Adiciona novos autos para os demais
                            addAuto();
                            const autoId = index + 1;
                            document.getElementById(`auto_numero_${autoId}`).value = auto.numero || '';
                            document.getElementById(`auto_descricao_${autoId}`).value = auto.descricao || '';
                        }
                    });
                }
                
                // Carrega termos
                if (reportData.termos && reportData.termos.length > 0) {
                    reportData.termos.forEach((termo, index) => {
                        if (index === 0) {
                            // Usa o primeiro termo que já existe
                            document.getElementById('termo_tipo_1').value = termo.tipo || '';
                            document.getElementById('termo_numero_1').value = termo.numero || '';
                            termoCount = 1;
                        } else {
                            // Adiciona novos termos para os demais
                            addTermo();
                            const termoId = index + 1;
                            document.getElementById(`termo_tipo_${termoId}`).value = termo.tipo || '';
                            document.getElementById(`termo_numero_${termoId}`).value = termo.numero || '';
                        }
                    });
                }
                
                // Carrega fotos
                if (reportData.photos && reportData.photos.length > 0) {
                    reportData.photos.forEach(photo => {
                        if (photo.src) {
                            // Cria um elemento de foto manualmente
                            photoCount++;
                            const photoContainer = document.getElementById('photo-container');
                            const template = photoContainer.querySelector('.photo-item');
                            const newPhoto = template.cloneNode(true);
                            
                            newPhoto.style.display = 'block';
                            newPhoto.querySelector('.photo-number').textContent = `Figura ${photoCount}`;
                            newPhoto.querySelector('.photo-preview').src = photo.src;
                            newPhoto.querySelector('.photo-caption').value = photo.caption || '';
                            newPhoto.querySelector('.photo-coords').value = photo.coords || '';
                            newPhoto.querySelector('.coord-source').textContent = photo.coordSource || '';
                            
                            newPhoto.querySelector('.remove-photo').addEventListener('click', function() {
                                photoContainer.removeChild(newPhoto);
                                updatePhotoNumbers();
                            });
                            
                            photoContainer.appendChild(newPhoto);
                        }
                    });
                }
                
                alert('Dados carregados com sucesso!');
                
                // Atualiza o QRCode com os dados carregados
                generateQRCode();
            } catch (e) {
                alert('Erro ao carregar dados: ' + e.message);
            }
        }
        
        // Valida o formulário
        function validateForm() {
            // Verifica campos obrigatórios
            const requiredFields = [
                'data', 'hora', 'local', 'infrator_nome', 'infrator_documento',
                'latitude', 'longitude', 'descricao', 'fiscal_nome', 'fiscal_matricula'
            ];
            
            for (const fieldId of requiredFields) {
                const field = document.getElementById(fieldId);
                if (!field.value.trim()) {
                    field.focus();
                    return false;
                }
            }
            
            // Verifica pelo menos um auto de infração preenchido
            let hasAuto = false;
            document.querySelectorAll('.auto-numero').forEach(auto => {
                if (auto.value.trim()) hasAuto = true;
            });
            
            if (!hasAuto) {
                alert('Pelo menos um auto de infração deve ser preenchido.');
                return false;
            }
            
            // Verifica assinatura
            if (signaturePad.isEmpty()) {
                alert('Por favor, forneça sua assinatura.');
                return false;
            }
            
            return true;
        }
        
        // Atualiza o status da conexão
        function updateConnectionStatus() {
            isOnline = navigator.onLine;
            const connectionStatus = document.getElementById('connectionStatus');
            
            if (isOnline) {
                connectionStatus.textContent = 'Online';
                connectionStatus.className = 'connection-status online';
                
                // Recarrega o mapa se estiver offline
                if (!map) {
                    const lat = parseFloat(document.getElementById('latitude').value) || -15.788;
                    const lng = parseFloat(document.getElementById('longitude').value) || -47.879;
                    initMap(lat, lng);
                }
            } else {
                connectionStatus.textContent = 'Offline';
                connectionStatus.className = 'connection-status offline';
            }
        }
        
        // Gera QR Code com informações do relatório
        function generateQRCode() {
            const qrElement = document.getElementById('qrcode');
            qrElement.innerHTML = '';
            
            // Cria um ID único baseado nos dados atuais
            const reportId = `REL-${document.getElementById('data').value}-${document.getElementById('auto_numero_1').value || '000'}`;
            
            // Gera o QR Code
            QRCode.toCanvas(qrElement, reportId, { width: 150 }, function(error) {
                if (error) console.error('Erro ao gerar QR Code:', error);
            });
        }
    </script>
</body>
</html>
