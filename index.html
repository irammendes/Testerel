<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Relatório Fotográfico Ambiental 3.5</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            line-height: 1.6;
        }
        .container {
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 5px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }
        .header {
            text-align: center;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #006400;
        }
        h1, h2 {
            color: #006400;
        }
        .form-section {
            margin-bottom: 25px;
            page-break-inside: avoid;
            break-inside: avoid;
        }
        .form-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            font-weight: bold;
            margin-bottom: 5px;
        }
        input, textarea, select {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
        }
        #map {
            height: 400px;
            width: 100%;
            margin: 15px 0;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .btn {
            background-color: #006400;
            color: white;
            padding: 10px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin-top: 10px;
        }
        .btn-secondary {
            background-color: #6c757d;
        }
        .btn-danger {
            background-color: #dc3545;
        }
        .coordinates {
            display: flex;
            gap: 15px;
        }
        .coord-input {
            flex: 1;
        }
        .error {
            color: red;
            margin-top: 5px;
        }
        .photo-container {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-top: 15px;
            page-break-inside: avoid;
            break-inside: avoid;
        }
        .photo-item {
            flex: 1 1 300px;
            border: 1px solid #ddd;
            padding: 10px;
            border-radius: 5px;
            position: relative;
            page-break-inside: avoid;
            break-inside: avoid;
        }
        .photo-number {
            position: absolute;
            top: 5px;
            left: 5px;
            background-color: rgba(0, 100, 0, 0.7);
            color: white;
            padding: 3px 8px;
            border-radius: 3px;
            font-weight: bold;
        }
        .photo-preview {
            width: 100%;
            height: 200px;
            object-fit: cover;
            background-color: #f5f5f5;
            margin-bottom: 10px;
        }
        .datetime-group {
            display: flex;
            gap: 15px;
        }
        .datetime-input {
            flex: 1;
        }
        .dms-coordinates {
            font-family: monospace;
            background-color: #f5f5f5;
            padding: 5px;
            border-radius: 3px;
        }
        .action-buttons {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 20px;
        }
        .connection-status {
            position: fixed;
            top: 10px;
            right: 10px;
            padding: 5px 10px;
            border-radius: 4px;
            color: white;
            font-weight: bold;
            z-index: 1000;
        }
        .online {
            background-color: #28a745;
        }
        .offline {
            background-color: #dc3545;
        }
        .footer {
            text-align: center;
            margin-top: 30px;
            padding-top: 15px;
            border-top: 1px solid #ddd;
            font-size: 0.9em;
            color: #666;
        }
        .termo-item, .auto-item, .infrator-item {
            border: 1px solid #ddd;
            padding: 15px;
            margin-bottom: 15px;
            border-radius: 4px;
            page-break-inside: avoid;
            break-inside: avoid;
            background-color: #f9f9f9;
        }
        .add-btn {
            margin-bottom: 15px;
        }
        #signature-pad {
            border: 1px solid #ddd;
            border-radius: 4px;
            background-color: white;
        }
        .signature-clear {
            margin-top: 10px;
        }
        #qrcode {
            margin: 15px 0;
            text-align: center;
        }
        .alert-warning {
            display: none;
            padding: 10px;
            background: #fff3cd;
            margin-bottom: 15px;
            border-radius: 4px;
        }
        .page-break {
            page-break-after: always;
            break-after: page;
        }
        .avoid-break {
            page-break-inside: avoid;
            break-inside: avoid;
        }
        .coord-source {
            font-size: 0.8em;
            color: #666;
            font-style: italic;
        }
        .infrator-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        .infrator-title {
            font-weight: bold;
            color: #006400;
        }
        .remove-infrator {
            background-color: #dc3545;
            color: white;
            border: none;
            border-radius: 3px;
            padding: 5px 10px;
            cursor: pointer;
        }
        .remove-infrator:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }
        
        /* Estilos específicos para impressão/PDF */
        @media print {
            .no-print {
                display: none !important;
            }
            body {
                margin: 0;
                padding: 0;
                font-size: 12pt;
                line-height: 1.3;
            }
            .container {
                max-width: 100%;
                border: none;
                box-shadow: none;
                padding: 0;
            }
            .header {
                margin-bottom: 15pt;
                padding-bottom: 5pt;
            }
            h1 {
                font-size: 18pt;
                margin-bottom: 10pt;
            }
            h2 {
                font-size: 14pt;
                margin-top: 15pt;
                margin-bottom: 8pt;
            }
            .form-section {
                margin-bottom: 20pt;
            }
            .photo-item {
                page-break-inside: avoid;
                margin-bottom: 15pt;
            }
            .photo-preview {
                max-height: 250pt;
                height: auto;
            }
            #signature-pad {
                width: 100% !important;
                height: 80pt !important;
            }
            .footer {
                display: none;
            }
            
            /* Cabeçalho e rodapé das páginas */
            @page {
                size: A4;
                margin: 2cm 1.5cm 2cm 1.5cm;
                
                @top-center {
                    content: "Relatório Fotográfico Ambiental - ICMBio";
                    font-size: 10pt;
                    border-bottom: 1px solid #006400;
                    padding-bottom: 5pt;
                }
                
                @bottom-center {
                    content: "Página " counter(page) " de " counter(pages);
                    font-size: 10pt;
                    border-top: 1px solid #006400;
                    padding-top: 5pt;
                }
            }
        }
    </style>
</head>
<body>
    <div id="connectionStatus" class="connection-status offline">Offline</div>
    <div id="storage-warning" class="alert-warning">
        Atenção: O armazenamento está quase cheio. Alguns dados podem não ser salvos.
    </div>
    
    <div class="container" id="relatorio">
        <div class="header">
            <h1>Relatório Fotográfico Ambiental - Versão 3.5</h1>
            <p>Instituto Chico Mendes de Conservação da Biodiversidade - ICMBio</p>
            <div id="qrcode"></div>
        </div>
        
        <div class="form-section">
            <h2>Dados do Relatório</h2>
            
            <div class="datetime-group">
                <div class="datetime-input">
                    <label for="data">Data:</label>
                    <input type="date" id="data" required>
                </div>
                <div class="datetime-input">
                    <label for="hora">Hora:</label>
                    <input type="time" id="hora" required>
                </div>
            </div>
            
            <div class="form-group">
                <label for="local">Local da Fiscalização:</label>
                <input type="text" id="local" required>
            </div>
        </div>
        
        <div class="form-section">
            <h2>Infratores</h2>
            <div id="infratores-container">
                <div class="infrator-item">
                    <div class="infrator-header">
                        <span class="infrator-title">Infrator #1</span>
                        <button class="remove-infrator no-print" data-id="1" disabled>Remover</button>
                    </div>
                    <div class="form-group">
                        <label for="infrator_nome_1">Nome do Infrator:</label>
                        <input type="text" id="infrator_nome_1" class="infrator-nome" required>
                    </div>
                    <div class="form-group">
                        <label for="infrator_documento_1">CPF/CNPJ:</label>
                        <input type="text" id="infrator_documento_1" class="infrator-documento" required>
                    </div>
                    <div class="form-group">
                        <label for="infrator_endereco_1">Endereço:</label>
                        <input type="text" id="infrator_endereco_1" class="infrator-endereco">
                    </div>
                    <div class="form-group">
                        <label for="infrator_contato_1">Contato:</label>
                        <input type="text" id="infrator_contato_1" class="infrator-contato">
                    </div>
                </div>
            </div>
            <button id="add-infrator" class="btn btn-secondary add-btn no-print">Adicionar Infrator</button>
        </div>
        
        <div class="form-group">
            <label>Coordenadas Geográficas (Graus Decimais):</label>
            <div class="coordinates">
                <input type="text" id="latitude" class="coord-input" placeholder="Latitude" readonly>
                <input type="text" id="longitude" class="coord-input" placeholder="Longitude" readonly>
            </div>
            <div id="coord-error" class="error"></div>
            <div class="form-group">
                <input type="checkbox" id="rastreamento" checked>
                <label for="rastreamento" style="display: inline;">Atualizar coordenadas automaticamente</label>
            </div>
        </div>
        
        <div class="form-group">
            <label>Coordenadas em Graus, Minutos e Segundos:</label>
            <div id="dms-coordinates" class="dms-coordinates">Não disponível</div>
        </div>
        
        <div class="buttons no-print">
            <button id="get-location" class="btn">Obter Localização Atual</button>
            <button id="manual-coords" class="btn btn-secondary">Inserir Coordenadas Manualmente</button>
        </div>
        
        <div id="map"></div>
        
        <div class="form-section">
            <h2>Autos de Infração</h2>
            <div id="autos-container">
                <div class="auto-item">
                    <div class="form-group">
                        <label for="auto_numero_1">Número do Auto de Infração:</label>
                        <input type="text" id="auto_numero_1" class="auto-numero" required>
                    </div>
                    <div class="form-group">
                        <label for="auto_descricao_1">Descrição da Infração:</label>
                        <textarea id="auto_descricao_1" class="auto-descricao" rows="3" required></textarea>
                    </div>
                </div>
            </div>
            <button id="add-auto" class="btn btn-secondary add-btn no-print">Adicionar outro Auto</button>
        </div>
        
        <div class="form-section">
            <h2>Termos</h2>
            <div id="termos-container">
                <div class="termo-item">
                    <div class="form-group">
                        <label for="termo_tipo_1">Tipo de Termo:</label>
                        <select id="termo_tipo_1" class="termo-tipo" required>
                            <option value="">Selecione...</option>
                            <option value="notificacao">Termo de Notificação</option>
                            <option value="apreensao">Termo de Apreensão</option>
                            <option value="embargo">Termo de Embargo</option>
                            <option value="soltura">Termo de Soltura</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="termo_numero_1">Número do Termo:</label>
                        <input type="text" id="termo_numero_1" class="termo-numero" required>
                    </div>
                </div>
            </div>
            <button id="add-termo" class="btn btn-secondary add-btn no-print">Adicionar outro Termo</button>
        </div>
        
        <div class="form-section">
            <h2>Descrição da Ação</h2>
            <div class="form-group">
                <label for="descricao">Descrição detalhada do que foi realizado em campo:</label>
                <textarea id="descricao" rows="6" required></textarea>
            </div>
        </div>
        
        <div class="form-section">
            <h2>Registro Fotográfico</h2>
            
            <div class="form-group no-print">
                <label for="photo-upload">Adicionar Fotos:</label>
                <input type="file" id="photo-upload" accept="image/*" multiple>
                <small>Selecione uma ou mais fotos para upload (com geolocalização preferencialmente)</small>
            </div>
            
            <div id="photo-container" class="photo-container">
                <!-- Template para novas fotos -->
                <div class="photo-item" style="display: none;">
                    <div class="photo-number">Figura 1</div>
                    <img class="photo-preview" src="">
                    <div class="form-group">
                        <label>Legenda:</label>
                        <input type="text" class="photo-caption" placeholder="Descreva a foto">
                    </div>
                    <div class="form-group">
                        <label>Coordenadas:</label>
                        <input type="text" class="photo-coords" readonly>
                        <div class="coord-source"></div>
                    </div>
                    <button class="btn btn-secondary remove-photo no-print">Remover</button>
                </div>
            </div>
        </div>
        
        <div class="form-section">
            <h2>Assinatura do Fiscal</h2>
            <div class="form-group">
                <label for="fiscal_nome">Nome do Fiscal:</label>
                <input type="text" id="fiscal_nome" required>
            </div>
            <div class="form-group">
                <label for="fiscal_matricula">Matrícula:</label>
                <input type="text" id="fiscal_matricula" required>
            </div>
            <div class="form-group">
                <label>Assinatura:</label>
                <canvas id="signature-pad" width="400" height="200"></canvas>
                <button id="clear-signature" class="btn btn-secondary signature-clear no-print">Limpar Assinatura</button>
            </div>
        </div>
        
        <div class="action-buttons no-print">
            <button id="print-report" class="btn">Imprimir Relatório</button>
            <button id="generate-pdf" class="btn btn-secondary">Gerar PDF</button>
            <button id="generate-word" class="btn btn-secondary">Gerar Word</button>
            <button id="generate-excel" class="btn btn-secondary">Gerar Excel</button>
            <button id="save-data" class="btn btn-secondary">Salvar Dados</button>
            <button id="load-data" class="btn btn-secondary">Carregar Dados</button>
            <button id="clear-storage" class="btn btn-danger">Limpar Armazenamento</button>
        </div>
        
        <div class="footer">
            <p>Todos os direitos reservados &copy; <span id="current-year"></span> - Iram Mendes Jr - Analista Ambiental - ICMBio</p>
        </div>
    </div>

    <!-- Bibliotecas JavaScript -->
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/signature_pad/1.5.3/signature_pad.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.1/build/qrcode.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/exif-js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <script src="https://unpkg.com/docx@7.8.2/build/index.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    
    <script>
        // Variáveis globais
        let map;
        let marker;
        let signaturePad;
        let watchPositionId = null;
        let autoCount = 1;
        let termoCount = 1;
        let photoCount = 0;
        let infratorCount = 1;
        let isOnline = navigator.onLine;
        
        // Inicialização
        document.addEventListener('DOMContentLoaded', function() {
            // Configura data e hora atuais
            const now = new Date();
            document.getElementById('data').value = now.toISOString().split('T')[0];
            document.getElementById('hora').value = now.toTimeString().substring(0, 5);
            document.getElementById('current-year').textContent = now.getFullYear();
            
            // Inicializa o mapa
            initMap(-15.788, -47.879);
            
            // Inicializa a área de assinatura
            const canvas = document.getElementById('signature-pad');
            signaturePad = new SignaturePad(canvas);
            
            // Configura eventos
            setupEventListeners();
            
            // Atualiza status da conexão
            updateConnectionStatus();
            
            // Gera QR Code inicial
            generateQRCode();
            
            // Verifica espaço de armazenamento
            checkStorageSpace();
        });
        
        // Configura os listeners de eventos
        function setupEventListeners() {
            // Botões de localização
            document.getElementById('get-location').addEventListener('click', getLocation);
            document.getElementById('manual-coords').addEventListener('click', manualCoords);
            
            // Botões de formulário
            document.getElementById('add-auto').addEventListener('click', addAuto);
            document.getElementById('add-termo').addEventListener('click', addTermo);
            document.getElementById('add-infrator').addEventListener('click', addInfrator);
            
            // Upload de fotos
            document.getElementById('photo-upload').addEventListener('change', handlePhotoUpload);
            
            // Ações principais
            document.getElementById('print-report').addEventListener('click', printReport);
            document.getElementById('generate-pdf').addEventListener('click', generatePDF);
            document.getElementById('generate-word').addEventListener('click', generateWord);
            document.getElementById('generate-excel').addEventListener('click', generateExcel);
            document.getElementById('save-data').addEventListener('click', saveData);
            document.getElementById('load-data').addEventListener('click', loadData);
            document.getElementById('clear-signature').addEventListener('click', clearSignature);
            document.getElementById('clear-storage').addEventListener('click', clearStorage);
            
            // Monitora mudanças na conexão
            window.addEventListener('online', updateConnectionStatus);
            window.addEventListener('offline', updateConnectionStatus);
        }
        
        // Funções do mapa e geolocalização (manter as mesmas)
        function initMap(lat, lng) {
            if (map) {
                map.setView([lat, lng], 15);
                if (marker) {
                    marker.setLatLng([lat, lng]);
                }
                return;
            }
            
            map = L.map('map').setView([lat, lng], 15);
            
            // Camadas base
            const streetLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            });
            
            const satelliteLayer = L.tileLayer('https://mt1.google.com/vt/lyrs=s&x={x}&y={y}&z={z}', {
                attribution: 'Imagens © Google Satellite'
            });
            
            // Adiciona camada padrão
            if (isOnline) {
                satelliteLayer.addTo(map);
            } else {
                document.getElementById('map').innerHTML = 
                    '<p style="text-align: center; padding-top: 180px;">Mapa offline não disponível. Conecte-se à internet para carregar mapas.</p>';
            }
            
            // Adiciona marcador
            marker = L.marker([lat, lng], { draggable: true }).addTo(map);
            
            // Atualiza coordenadas quando o marcador é movido
            marker.on('dragend', function() {
                const newLatLng = marker.getLatLng();
                updateCoordinates(newLatLng.lat, newLatLng.lng);
            });
            
            // Atualiza coordenadas quando clica no mapa
            map.on('click', function(e) {
                updateCoordinates(e.latlng.lat, e.latlng.lng);
                if (!marker) {
                    marker = L.marker(e.latlng, { draggable: true }).addTo(map);
                    marker.on('dragend', function() {
                        const newLatLng = marker.getLatLng();
                        updateCoordinates(newLatLng.lat, newLatLng.lng);
                    });
                } else {
                    marker.setLatLng(e.latlng);
                }
            });
        }
        
        function getLocation() {
            const coordError = document.getElementById('coord-error');
            coordError.textContent = 'Obtendo localização...';
            
            if (!navigator.geolocation) {
                coordError.textContent = 'Geolocalização não é suportada pelo seu navegador';
                return;
            }
            
            // Para qualquer rastreamento anterior
            if (watchPositionId) {
                navigator.geolocation.clearWatch(watchPositionId);
            }
            
            const rastreamentoAtivo = document.getElementById('rastreamento').checked;
            
            if (rastreamentoAtivo) {
                // Rastreamento contínuo
                watchPositionId = navigator.geolocation.watchPosition(
                    position => {
                        const lat = position.coords.latitude;
                        const lng = position.coords.longitude;
                        updateCoordinates(lat, lng);
                        initMap(lat, lng);
                        coordError.textContent = 'Rastreamento ativo - coordenadas atualizadas';
                    },
                    error => {
                        handleGeolocationError(error);
                    },
                    { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
                );
            } else {
                // Única leitura
                navigator.geolocation.getCurrentPosition(
                    position => {
                        const lat = position.coords.latitude;
                        const lng = position.coords.longitude;
                        updateCoordinates(lat, lng);
                        initMap(lat, lng);
                        coordError.textContent = '';
                    },
                    error => {
                        handleGeolocationError(error);
                    },
                    { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
                );
            }
        }
        
        function handleGeolocationError(error) {
            const coordError = document.getElementById('coord-error');
            let errorMessage;
            
            switch(error.code) {
                case error.PERMISSION_DENIED:
                    errorMessage = "Permissão de localização negada pelo usuário";
                    break;
                case error.POSITION_UNAVAILABLE:
                    errorMessage = "Informações de localização indisponíveis";
                    break;
                case error.TIMEOUT:
                    errorMessage = "Tempo limite para obter localização excedido";
                    break;
                default:
                    errorMessage = "Ocorreu um erro desconhecido";
            }
            
            coordError.textContent = "Erro: " + errorMessage;
        }
        
        function manualCoords() {
            const lat = prompt("Digite a latitude (ex: -15.788):");
            const lng = prompt("Digite a longitude (ex: -47.879):");
            
            if (lat && lng && !isNaN(lat) && !isNaN(lng)) {
                updateCoordinates(parseFloat(lat), parseFloat(lng));
                initMap(parseFloat(lat), parseFloat(lng));
            } else {
                alert("Coordenadas inválidas. Por favor, insira valores numéricos.");
            }
        }
        
        function updateCoordinates(lat, lng) {
            document.getElementById('latitude').value = lat.toFixed(6);
            document.getElementById('longitude').value = lng.toFixed(6);
            updateDMSCoordinates(lat, lng);
            document.getElementById('coord-error').textContent = '';
        }
        
        function decimalToDMS(decimal, isLatitude) {
            const absDecimal = Math.abs(decimal);
            const degrees = Math.floor(absDecimal);
            const minutesNotTruncated = (absDecimal - degrees) * 60;
            const minutes = Math.floor(minutesNotTruncated);
            const seconds = ((minutesNotTruncated - minutes) * 60).toFixed(2);
            
            const direction = isLatitude 
                ? (decimal >= 0 ? 'N' : 'S') 
                : (decimal >= 0 ? 'E' : 'W');
            
            return `${degrees}° ${minutes}' ${seconds}" ${direction}`;
        }
        
        function updateDMSCoordinates(lat, lng) {
            const latDMS = decimalToDMS(lat, true);
            const lngDMS = decimalToDMS(lng, false);
            document.getElementById('dms-coordinates').textContent = 
                `Latitude: ${latDMS} | Longitude: ${lngDMS}`;
        }
        
        // Funções para adicionar elementos dinâmicos
        function addAuto() {
            autoCount++;
            const newAuto = document.createElement('div');
            newAuto.className = 'auto-item';
            newAuto.innerHTML = `
                <div class="form-group">
                    <label for="auto_numero_${autoCount}">Número do Auto de Infração:</label>
                    <input type="text" id="auto_numero_${autoCount}" class="auto-numero" required>
                </div>
                <div class="form-group">
                    <label for="auto_descricao_${autoCount}">Descrição da Infração:</label>
                    <textarea id="auto_descricao_${autoCount}" class="auto-descricao" rows="3" required></textarea>
                </div>
                <button class="btn btn-secondary remove-auto no-print" data-id="${autoCount}">Remover Auto</button>
            `;
            document.getElementById('autos-container').appendChild(newAuto);
            
            newAuto.querySelector('.remove-auto').addEventListener('click', function() {
                if (autoCount > 1) {
                    document.getElementById('autos-container').removeChild(newAuto);
                    autoCount--;
                } else {
                    alert("Pelo menos um auto de infração deve ser mantido.");
                }
            });
        }
        
        function addTermo() {
            termoCount++;
            const newTermo = document.createElement('div');
            newTermo.className = 'termo-item';
            newTermo.innerHTML = `
                <div class="form-group">
                    <label for="termo_tipo_${termoCount}">Tipo de Termo:</label>
                    <select id="termo_tipo_${termoCount}" class="termo-tipo" required>
                        <option value="">Selecione...</option>
                        <option value="notificacao">Termo de Notificação</option>
                        <option value="apreensao">Termo de Apreensão</option>
                        <option value="embargo">Termo de Embargo</option>
                        <option value="soltura">Termo de Soltura</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="termo_numero_${termoCount}">Número do Termo:</label>
                    <input type="text" id="termo_numero_${termoCount}" class="termo-numero" required>
                </div>
                <button class="btn btn-secondary remove-termo no-print" data-id="${termoCount}">Remover Termo</button>
            `;
            document.getElementById('termos-container').appendChild(newTermo);
            
            newTermo.querySelector('.remove-termo').addEventListener('click', function() {
                if (termoCount > 1) {
                    document.getElementById('termos-container').removeChild(newTermo);
                    termoCount--;
                } else {
                    alert("Pelo menos um termo deve ser mantido.");
                }
            });
        }
        
        function addInfrator() {
            infratorCount++;
            const newInfrator = document.createElement('div');
            newInfrator.className = 'infrator-item';
            newInfrator.innerHTML = `
                <div class="infrator-header">
                    <span class="infrator-title">Infrator #${infratorCount}</span>
                    <button class="remove-infrator no-print" data-id="${infratorCount}">Remover</button>
                </div>
                <div class="form-group">
                    <label for="infrator_nome_${infratorCount}">Nome do Infrator:</label>
                    <input type="text" id="infrator_nome_${infratorCount}" class="infrator-nome" required>
                </div>
                <div class="form-group">
                    <label for="infrator_documento_${infratorCount}">CPF/CNPJ:</label>
                    <input type="text" id="infrator_documento_${infratorCount}" class="infrator-documento" required>
                </div>
                <div class="form-group">
                    <label for="infrator_endereco_${infratorCount}">Endereço:</label>
                    <input type="text" id="infrator_endereco_${infratorCount}" class="infrator-endereco">
                </div>
                <div class="form-group">
                    <label for="infrator_contato_${infratorCount}">Contato:</label>
                    <input type="text" id="infrator_contato_${infratorCount}" class="infrator-contato">
                </div>
            `;
            document.getElementById('infratores-container').appendChild(newInfrator);
            
            newInfrator.querySelector('.remove-infrator').addEventListener('click', function() {
                if (infratorCount > 1) {
                    document.getElementById('infratores-container').removeChild(newInfrator);
                    infratorCount--;
                }
            });
        }
        
        // Funções para manipulação de fotos
        function handlePhotoUpload(e) {
            const files = e.target.files;
            const defaultCoords = {
                lat: parseFloat(document.getElementById('latitude').value) || -15.788,
                lng: parseFloat(document.getElementById('longitude').value) || -47.879,
                fromExif: false
            };
            
            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                
                if (file.type.match('image.*')) {
                    const reader = new FileReader();
                    
                    reader.onload = function(e) {
                        EXIF.getData(file, function() {
                            const exifData = EXIF.getAllTags(this);
                            let coords = {...defaultCoords};
                            
                            if (exifData.GPSLatitude && exifData.GPSLongitude) {
                                coords = {
                                    lat: convertDMSToDD(
                                        exifData.GPSLatitude[0],
                                        exifData.GPSLatitude[1],
                                        exifData.GPSLatitude[2],
                                        exifData.GPSLatitudeRef
                                    ),
                                    lng: convertDMSToDD(
                                        exifData.GPSLongitude[0],
                                        exifData.GPSLongitude[1],
                                        exifData.GPSLongitude[2],
                                        exifData.GPSLongitudeRef
                                    ),
                                    fromExif: true
                                };
                            }
                            
                            addPhoto(file, coords);
                        });
                    };
                    reader.readAsDataURL(file);
                } else {
                    addPhoto(file, defaultCoords);
                }
            }
            
            e.target.value = '';
        }

        function convertDMSToDD(degrees, minutes, seconds, direction) {
            let dd = Number(degrees) + (Number(minutes) / 60) + (Number(seconds) / 3600);
            if (direction === 'S' || direction === 'W') {
                dd = dd * -1;
            }
            return dd;
        }
        
        function addPhoto(file, coords) {
            photoCount++;
            const photoContainer = document.getElementById('photo-container');
            const template = photoContainer.querySelector('.photo-item');
            const newPhoto = template.cloneNode(true);
            
            newPhoto.style.display = 'block';
            newPhoto.querySelector('.photo-number').textContent = `Figura ${photoCount}`;
            newPhoto.querySelector('.photo-preview').src = URL.createObjectURL(file);
            
            const coordSource = coords.fromExif ? 
                '(Coordenadas extraídas da foto)' : 
                '(Coordenadas do formulário)';
            
            newPhoto.querySelector('.photo-coords').value = 
                `${coords.lat.toFixed(6)}, ${coords.lng.toFixed(6)}`;
            newPhoto.querySelector('.coord-source').textContent = coordSource;
            
            newPhoto.querySelector('.photo-caption').placeholder = "Descreva a foto...";
            
            newPhoto.querySelector('.remove-photo').addEventListener('click', function() {
                photoContainer.removeChild(newPhoto);
                updatePhotoNumbers();
            });
            
            photoContainer.appendChild(newPhoto);
        }
        
        function updatePhotoNumbers() {
            const photos = document.querySelectorAll('.photo-item:not([style*="display: none"])');
            photoCount = 0;
            
            photos.forEach((photo, index) => {
                photoCount++;
                photo.querySelector('.photo-number').textContent = `Figura ${photoCount}`;
            });
        }
        
        // Funções de utilidade
        function clearSignature() {
            signaturePad.clear();
        }
        
        function clearStorage() {
            if (confirm('Tem certeza que deseja limpar todos os dados salvos?')) {
                localStorage.clear();
                alert('Armazenamento limpo com sucesso!');
                document.getElementById('storage-warning').style.display = 'none';
            }
        }
        
        function printReport() {
            window.print();
        }
        
        function checkStorageSpace() {
            try {
                const testKey = 'storage_test';
                let data = '';
                for (let i = 0; i < 1024; i++) {
                    data += '1234567890';
                }
                
                localStorage.setItem(testKey, data);
                localStorage.removeItem(testKey);
                document.getElementById('storage-warning').style.display = 'none';
                return true;
            } catch (e) {
                if (e.name === 'QuotaExceededError') {
                    document.getElementById('storage-warning').style.display = 'block';
                    return false;
                }
                return true;
            }
        }
        
        function updateConnectionStatus() {
            isOnline = navigator.onLine;
            const connectionStatus = document.getElementById('connectionStatus');
            
            if (isOnline) {
                connectionStatus.textContent = 'Online';
                connectionStatus.className = 'connection-status online';
                
                if (!map) {
                    const lat = parseFloat(document.getElementById('latitude').value) || -15.788;
                    const lng = parseFloat(document.getElementById('longitude').value) || -47.879;
                    initMap(lat, lng);
                }
            } else {
                connectionStatus.textContent = 'Offline';
                connectionStatus.className = 'connection-status offline';
            }
        }
        
        function generateQRCode() {
            const qrElement = document.getElementById('qrcode');
            qrElement.innerHTML = '';
            
            const reportId = `REL-${document.getElementById('data').value}-${document.getElementById('auto_numero_1').value || '000'}`;
            
            QRCode.toCanvas(qrElement, reportId, { width: 150 }, function(error) {
                if (error) console.error('Erro ao gerar QR Code:', error);
            });
        }
        
        function blobToArrayBuffer(blob) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result);
                reader.onerror = reject;
                reader.readAsArrayBuffer(blob);
            });
        }
        
        // Funções de exportação
        function generatePDF() {
            if (!checkStorageSpace()) {
                alert('Não é possível gerar PDF com armazenamento cheio.');
                return;
            }

            const loadingMessage = document.createElement('div');
            loadingMessage.style.position = 'fixed';
            loadingMessage.style.top = '50%';
            loadingMessage.style.left = '50%';
            loadingMessage.style.transform = 'translate(-50%, -50%)';
            loadingMessage.style.backgroundColor = 'rgba(0,0,0,0.7)';
            loadingMessage.style.color = 'white';
            loadingMessage.style.padding = '20px';
            loadingMessage.style.borderRadius = '5px';
            loadingMessage.style.zIndex = '9999';
            loadingMessage.textContent = 'Gerando PDF, por favor aguarde...';
            document.body.appendChild(loadingMessage);

            const { jsPDF } = window.jspdf;
            const doc = new jsPDF({
                orientation: 'portrait',
                unit: 'pt',
                format: 'a4'
            });

            const padding = 40;
            const pageWidth = doc.internal.pageSize.getWidth() - padding * 2;
            const pageHeight = doc.internal.pageSize.getHeight() - padding - 40;

            const sections = Array.from(document.querySelectorAll('.form-section')).filter(
                section => !section.querySelector('.photo-container')
            );
            
            let currentHeight = padding + 20;
            let pageNumber = 1;

            const addHeaderFooter = (doc, pageNum, totalPages) => {
                doc.setFontSize(14);
                doc.setTextColor(0, 100, 0);
                doc.text('Relatório Fotográfico Ambiental', padding, padding - 10);
                
                doc.setFontSize(10);
                doc.setTextColor(100, 100, 100);
                doc.text(`Página ${pageNum} de ${totalPages}`, 
                        doc.internal.pageSize.getWidth() - padding - 50, 
                        padding - 10);
            };

            const processTextSections = async (index) => {
                if (index >= sections.length) {
                    await processPhotos();
                    doc.save('relatorio_ambiental.pdf');
                    document.body.removeChild(loadingMessage);
                    return;
                }

                const section = sections[index];
                
                try {
                    const canvas = await html2canvas(section, {
                        scale: 2,
                        logging: false,
                        useCORS: true,
                        allowTaint: true,
                        backgroundColor: '#FFFFFF'
                    });
                    
                    const imgData = canvas.toDataURL('image/png');
                    const imgWidth = pageWidth;
                    const imgHeight = (canvas.height * imgWidth) / canvas.width;

                    if (index > 0 && (currentHeight + imgHeight > pageHeight)) {
                        doc.addPage();
                        currentHeight = padding + 20;
                        pageNumber++;
                    }

                    addHeaderFooter(doc, pageNumber, '...');
                    doc.addImage(imgData, 'PNG', padding, currentHeight, imgWidth, imgHeight);
                    currentHeight += imgHeight + 20;

                    processTextSections(index + 1);
                } catch (error) {
                    document.body.removeChild(loadingMessage);
                    console.error('Erro ao gerar PDF:', error);
                    alert('Ocorreu um erro ao gerar o PDF: ' + error.message);
                }
            };

            const processPhotos = async () => {
                const photoItems = document.querySelectorAll('.photo-item:not([style*="display: none"])');
                const photoCount = photoItems.length;
                
                if (photoCount === 0) return;

                const photosPerPage = 2;
                const photoPages = Math.ceil(photoCount / photosPerPage);
                const photoWidth = pageWidth;
                const photoHeight = (pageHeight - 40) / photosPerPage;
                
                for (let i = 0; i < photoCount; i++) {
                    const photoIndex = i + 1;
                    const photo = photoItems[i];
                    
                    if (i % photosPerPage === 0) {
                        if (i > 0 || sections.length > 0) {
                            doc.addPage();
                        }
                        pageNumber++;
                        currentHeight = padding + 20;
                        addHeaderFooter(doc, pageNumber, pageNumber + photoPages - Math.ceil((i + 1) / photosPerPage));
                    }
                    
                    try {
                        const tempContainer = document.createElement('div');
                        tempContainer.style.width = photoWidth + 'px';
                        tempContainer.style.padding = '10px';
                        tempContainer.style.boxSizing = 'border-box';
                        
                        const photoClone = photo.cloneNode(true);
                        photoClone.style.width = '100%';
                        photoClone.style.margin = '0';
                        photoClone.style.padding = '0';
                        
                        const removeBtn = photoClone.querySelector('.remove-photo');
                        if (removeBtn) removeBtn.remove();
                        
                        tempContainer.appendChild(photoClone);
                        document.body.appendChild(tempContainer);
                        
                        const canvas = await html2canvas(tempContainer, {
                            scale: 2,
                            logging: false,
                            useCORS: true,
                            allowTaint: true,
                            backgroundColor: '#FFFFFF'
                        });
                        
                        document.body.removeChild(tempContainer);
                        
                        const imgData = canvas.toDataURL('image/png');
                        const imgHeight = (canvas.height * photoWidth) / canvas.width;
                        const finalHeight = Math.min(imgHeight, photoHeight);
                        
                        doc.addImage(
                            imgData, 
                            'PNG', 
                            padding, 
                            currentHeight, 
                            photoWidth, 
                            finalHeight
                        );
                        
                        currentHeight += finalHeight + 20;
                        
                    } catch (error) {
                        console.error('Erro ao processar foto:', error);
                    }
                }
            };

            processTextSections(0);
        }
        
        async function generateWord() {
            if (!validateForm()) {
                alert('Por favor, preencha todos os campos obrigatórios antes de gerar o documento.');
                return;
            }

            const loadingMessage = document.createElement('div');
            loadingMessage.style.position = 'fixed';
            loadingMessage.style.top = '50%';
            loadingMessage.style.left = '50%';
            loadingMessage.style.transform = 'translate(-50%, -50%)';
            loadingMessage.style.backgroundColor = 'rgba(0,0,0,0.7)';
            loadingMessage.style.color = 'white';
            loadingMessage.style.padding = '20px';
            loadingMessage.style.borderRadius = '5px';
            loadingMessage.style.zIndex = '9999';
            loadingMessage.textContent = 'Gerando documento Word, por favor aguarde...';
            document.body.appendChild(loadingMessage);

            try {
                const { Document, Paragraph, TextRun, HeadingLevel, Packer, ImageRun } = docx;

                const doc = new Document({
                    title: "Relatório Fotográfico Ambiental",
                    description: "Relatório gerado pelo sistema ICMBio",
                    styles: {
                        paragraphStyles: [
                            {
                                id: "normal",
                                name: "Normal",
                                run: {
                                    size: 24,
                                },
                                paragraph: {
                                    spacing: {
                                        line: 276,
                                    },
                                },
                            },
                            {
                                id: "titulo1",
                                name: "Título 1",
                                basedOn: "normal",
                                next: "normal",
                                run: {
                                    bold: true,
                                    size: 36,
                                    color: "006400",
                                },
                                paragraph: {
                                    spacing: {
                                        before: 240,
                                        after: 120,
                                    },
                                },
                            },
                            {
                                id: "titulo2",
                                name: "Título 2",
                                basedOn: "normal",
                                next: "normal",
                                run: {
                                    bold: true,
                                    size: 30,
                                    color: "006400",
                                },
                                paragraph: {
                                    spacing: {
                                        before: 200,
                                        after: 100,
                                    },
                                },
                            },
                        ],
                    },
                    sections: [],
                });

                // Capa
                doc.addSection({
                    properties: {},
                    children: [
                        new Paragraph({
                            text: "Relatório Fotográfico Ambiental",
                            heading: HeadingLevel.HEADING_1,
                            style: "titulo1",
                            alignment: docx.AlignmentType.CENTER,
                            spacing: { after: 400 },
                        }),
                        new Paragraph({
                            text: "Instituto Chico Mendes de Conservação da Biodiversidade - ICMBio",
                            style: "normal",
                            alignment: docx.AlignmentType.CENTER,
                            spacing: { after: 600 },
                        }),
                        new Paragraph({
                            text: `Data: ${document.getElementById('data').value}`,
                            style: "normal",
                            alignment: docx.AlignmentType.RIGHT,
                        }),
                        new Paragraph({
                            text: `Local: ${document.getElementById('local').value}`,
                            style: "normal",
                            alignment: docx.AlignmentType.RIGHT,
                        }),
                    ],
                });

                // Dados do Relatório
                doc.addSection({
                    properties: {
                        page: {
                            margin: {
                                top: 1000,
                                bottom: 1000,
                                left: 1000,
                                right: 1000,
                            },
                        },
                    },
                    children: [
                        new Paragraph({
                            text: "1. Dados do Relatório",
                            heading: HeadingLevel.HEADING_1,
                            style: "titulo1",
                        }),
                        new Paragraph({
                            text: `Data: ${document.getElementById('data').value}`,
                            style: "normal",
                        }),
                        new Paragraph({
                            text: `Hora: ${document.getElementById('hora').value}`,
                            style: "normal",
                        }),
                        new Paragraph({
                            text: `Local da Fiscalização: ${document.getElementById('local').value}`,
                            style: "normal",
                        }),
                        new Paragraph({
                            text: `Coordenadas: ${document.getElementById('latitude').value}, ${document.getElementById('longitude').value}`,
                            style: "normal",
                        }),
                        new Paragraph({
                            text: `Coordenadas (DMS): ${document.getElementById('dms-coordinates').textContent}`,
                            style: "normal",
                        }),
                    ],
                });

                // Infratores
                doc.addSection({
                    children: [
                        new Paragraph({
                            text: "2. Infratores",
                            heading: HeadingLevel.HEADING_1,
                            style: "titulo1",
                        }),
                        ...Array.from(document.querySelectorAll('.infrator-item')).map((infrator, index) => {
                            const infratorId = index + 1;
                            return [
                                new Paragraph({
                                    text: `Infrator ${infratorId}`,
                                    heading: HeadingLevel.HEADING_2,
                                    style: "titulo2",
                                }),
                                new Paragraph({
                                    text: `Nome: ${document.getElementById(`infrator_nome_${infratorId}`).value}`,
                                    style: "normal",
                                }),
                                new Paragraph({
                                    text: `CPF/CNPJ: ${document.getElementById(`infrator_documento_${infratorId}`).value}`,
                                    style: "normal",
                                }),
                                new Paragraph({
                                    text: `Endereço: ${document.getElementById(`infrator_endereco_${infratorId}`).value || 'Não informado'}`,
                                    style: "normal",
                                }),
                                new Paragraph({
                                    text: `Contato: ${document.getElementById(`infrator_contato_${infratorId}`).value || 'Não informado'}`,
                                    style: "normal",
                                }),
                                new Paragraph({
                                    text: "",
                                    style: "normal",
                                }),
                            ];
                        }).flat(),
                    ],
                });

                // Autos de Infração
                doc.addSection({
                    children: [
                        new Paragraph({
                            text: "3. Autos de Infração",
                            heading: HeadingLevel.HEADING_1,
                            style: "titulo1",
                        }),
                        ...Array.from(document.querySelectorAll('.auto-item')).map((auto, index) => {
                            const autoId = index + 1;
                            return [
                                new Paragraph({
                                    text: `Auto ${autoId}`,
                                    heading: HeadingLevel.HEADING_2,
                                    style: "titulo2",
                                }),
                                new Paragraph({
                                    text: `Número: ${document.getElementById(`auto_numero_${autoId}`).value}`,
                                    style: "normal",
                                }),
                                new Paragraph({
                                    text: `Descrição: ${document.getElementById(`auto_descricao_${autoId}`).value}`,
                                    style: "normal",
                                }),
                                new Paragraph({
                                    text: "",
                                    style: "normal",
                                }),
                            ];
                        }).flat(),
                    ],
                });

                // Termos
                doc.addSection({
                    children: [
                        new Paragraph({
                            text: "4. Termos",
                            heading: HeadingLevel.HEADING_1,
                            style: "titulo1",
                        }),
                        ...Array.from(document.querySelectorAll('.termo-item')).map((termo, index) => {
                            const termoId = index + 1;
                            return [
                                new Paragraph({
                                    text: `Termo ${termoId}`,
                                    heading: HeadingLevel.HEADING_2,
                                    style: "titulo2",
                                }),
                                new Paragraph({
                                    text: `Tipo: ${document.getElementById(`termo_tipo_${termoId}`).value}`,
                                    style: "normal",
                                }),
                                new Paragraph({
                                    text: `Número: ${document.getElementById(`termo_numero_${termoId}`).value}`,
                                    style: "normal",
                                }),
                                new Paragraph({
                                    text: "",
                                    style: "normal",
                                }),
                            ];
                        }).flat(),
                    ],
                });

                // Descrição da Ação
                doc.addSection({
                    children: [
                        new Paragraph({
                            text: "5. Descrição da Ação",
                            heading: HeadingLevel.HEADING_1,
                            style: "titulo1",
                        }),
                        new Paragraph({
                            text: document.getElementById('descricao').value,
                            style: "normal",
                        }),
                    ],
                });

                // Fotos
                const photoItems = Array.from(document.querySelectorAll('.photo-item:not([style*="display: none"])'));
                if (photoItems.length > 0) {
                    doc.addSection({
                        children: [
                            new Paragraph({
                                text: "6. Registro Fotográfico",
                                heading: HeadingLevel.HEADING_1,
                                style: "titulo1",
                            }),
                        ],
                    });

                    for (let i = 0; i < photoItems.length; i += 2) {
                        const sectionChildren = [];
                        const photo1 = photoItems[i];
                        
                        sectionChildren.push(new Paragraph({
                            text: photo1.querySelector('.photo-number').textContent,
                            heading: HeadingLevel.HEADING_2,
                            style: "titulo2",
                        }));
                        
                        if (photo1.querySelector('.photo-caption').value) {
                            sectionChildren.push(new Paragraph({
                                text: `Legenda: ${photo1.querySelector('.photo-caption').value}`,
                                style: "normal",
                            }));
                        }
                        
                        sectionChildren.push(new Paragraph({
                            text: `Coordenadas: ${photo1.querySelector('.photo-coords').value}`,
                            style: "normal",
                        }));
                        
                        const img1 = photo1.querySelector('.photo-preview');
                        const canvas1 = await html2canvas(img1);
                        const imgData1 = canvas1.toDataURL('image/jpeg');
                        const blob1 = await (await fetch(imgData1)).blob();
                        
                        sectionChildren.push(new Paragraph({
                            children: [
                                new ImageRun({
                                    data: await blobToArrayBuffer(blob1),
                                    transformation: {
                                        width: 400,
                                        height: 300,
                                    },
                                }),
                            ],
                        }));
                        
                        if (i + 1 < photoItems.length) {
                            const photo2 = photoItems[i + 1];
                            
                            sectionChildren.push(new Paragraph({
                                text: photo2.querySelector('.photo-number').textContent,
                                heading: HeadingLevel.HEADING_2,
                                style: "titulo2",
                            }));
                            
                            if (photo2.querySelector('.photo-caption').value) {
                                sectionChildren.push(new Paragraph({
                                    text: `Legenda: ${photo2.querySelector('.photo-caption').value}`,
                                    style: "normal",
                                }));
                            }
                            
                            sectionChildren.push(new Paragraph({
                                text: `Coordenadas: ${photo2.querySelector('.photo-coords').value}`,
                                style: "normal",
                            }));
                            
                            const img2 = photo2.querySelector('.photo-preview');
                            const canvas2 = await html2canvas(img2);
                            const imgData2 = canvas2.toDataURL('image/jpeg');
                            const blob2 = await (await fetch(imgData2)).blob();
                            
                            sectionChildren.push(new Paragraph({
                                children: [
                                    new ImageRun({
                                        data: await blobToArrayBuffer(blob2),
                                        transformation: {
                                            width: 400,
                                            height: 300,
                                        },
                                    }),
                                ],
                            }));
                        }
                        
                        doc.addSection({
                            properties: {
                                page: {
                                    margin: {
                                        top: 1000,
                                        bottom: 1000,
                                        left: 1000,
                                        right: 1000,
                                    },
                                },
                            },
                            children: sectionChildren,
                        });
                    }
                }

                // Assinatura
                doc.addSection({
                    children: [
                        new Paragraph({
                            text: "7. Assinatura do Fiscal",
                            heading: HeadingLevel.HEADING_1,
                            style: "titulo1",
                        }),
                        new Paragraph({
                            text: `Nome: ${document.getElementById('fiscal_nome').value}`,
                            style: "normal",
                        }),
                        new Paragraph({
                            text: `Matrícula: ${document.getElementById('fiscal_matricula').value}`,
                            style: "normal",
                        }),
                        new Paragraph({
                            text: "Assinatura:",
                            style: "normal",
                        }),
                    ],
                });

                if (!signaturePad.isEmpty()) {
                    const signatureData = signaturePad.toDataURL('image/png');
                    const signatureBlob = await (await fetch(signatureData)).blob();
                    
                    doc.addSection({
                        children: [
                            new Paragraph({
                                children: [
                                    new ImageRun({
                                        data: await blobToArrayBuffer(signatureBlob),
                                        transformation: {
                                            width: 300,
                                            height: 100,
                                        },
                                    }),
                                ],
                            }),
                        ],
                    });
                }

                const blob = await Packer.toBlob(doc);
                saveAs(blob, `Relatorio_Ambiental_${document.getElementById('data').value}.docx`);

            } catch (error) {
                console.error("Erro ao gerar documento Word:", error);
                alert("Ocorreu um erro ao gerar o documento Word: " + error.message);
            } finally {
                document.body.removeChild(loadingMessage);
            }
        }
        
        function generateExcel() {
            if (!validateForm()) {
                alert('Por favor, preencha todos os campos obrigatórios antes de gerar a planilha.');
                return;
            }

            const reportData = {
                data: document.getElementById('data').value,
                hora: document.getElementById('hora').value,
                local: document.getElementById('local').value,
                latitude: document.getElementById('latitude').value,
                longitude: document.getElementById('longitude').value,
                descricao: document.getElementById('descricao').value,
                fiscal_nome: document.getElementById('fiscal_nome').value,
                fiscal_matricula: document.getElementById('fiscal_matricula').value,
                autos: [],
                termos: [],
                infratores: []
            };

            document.querySelectorAll('.auto-item').forEach((auto, index) => {
                const autoId = index + 1;
                reportData.autos.push({
                    numero: document.getElementById(`auto_numero_${autoId}`).value,
                    descricao: document.getElementById(`auto_descricao_${autoId}`).value
                });
            });

            document.querySelectorAll('.termo-item').forEach((termo, index) => {
                const termoId = index + 1;
                reportData.termos.push({
                    tipo: document.getElementById(`termo_tipo_${termoId}`).value,
                    numero: document.getElementById(`termo_numero_${termoId}`).value
                });
            });

            document.querySelectorAll('.infrator-item').forEach((infrator, index) => {
                const infratorId = index + 1;
                reportData.infratores.push({
                    nome: document.getElementById(`infrator_nome_${infratorId}`).value,
                    documento: document.getElementById(`infrator_documento_${infratorId}`).value,
                    endereco: document.getElementById(`infrator_endereco_${infratorId}`).value || '-',
                    contato: document.getElementById(`infrator_contato_${infratorId}`).value || '-'
                });
            });

            const excelData = [
                ["Relatório Fotográfico Ambiental - Banco de Dados"],
                ["Gerado em:", new Date().toLocaleString()],
                [],
                ["DADOS PRINCIPAIS"],
                ["Data", reportData.data],
                ["Hora", reportData.hora],
                ["Local", reportData.local],
                ["Latitude", reportData.latitude],
                ["Longitude", reportData.longitude],
                ["Fiscal", reportData.fiscal_nome],
                ["Matrícula", reportData.fiscal_matricula],
                ["Descrição", reportData.descricao],
                [],
                ["INFRATORES"],
                ["Nome", "CPF/CNPJ", "Endereço", "Contato"],
                ...reportData.infratores.map(i => [i.nome, i.documento, i.endereco, i.contato]),
                [],
                ["AUTOS DE INFRAÇÃO"],
                ["Número", "Descrição"],
                ...reportData.autos.map(a => [a.numero, a.descricao]),
                [],
                ["TERMOS"],
                ["Tipo", "Número"],
                ...reportData.termos.map(t => [t.tipo, t.numero])
            ];

            const ws = XLSX.utils.aoa_to_sheet(excelData);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Relatório");

            XLSX.writeFile(wb, `Banco_Dados_Ambiental_${reportData.data.replace(/-/g, '')}.xlsx`);
        }
        
        function saveData() {
            if (!validateForm()) {
                alert('Por favor, preencha todos os campos obrigatórios antes de salvar.');
                return;
            }
            
            if (!checkStorageSpace()) {
                alert('Armazenamento cheio. Não é possível salvar os dados.');
                return;
            }
            
            const reportData = {
                data: document.getElementById('data').value,
                hora: document.getElementById('hora').value,
                local: document.getElementById('local').value,
                latitude: document.getElementById('latitude').value,
                longitude: document.getElementById('longitude').value,
                descricao: document.getElementById('descricao').value,
                fiscal_nome: document.getElementById('fiscal_nome').value,
                fiscal_matricula: document.getElementById('fiscal_matricula').value,
                signature: signaturePad.isEmpty() ? null : signaturePad.toDataURL('image/png'),
                autos: [],
                termos: [],
                infratores: [],
                photos: []
            };
            
            document.querySelectorAll('.auto-item').forEach((auto, index) => {
                const autoId = index + 1;
                reportData.autos.push({
                    numero: document.getElementById(`auto_numero_${autoId}`).value,
                    descricao: document.getElementById(`auto_descricao_${autoId}`).value
                });
            });
            
            document.querySelectorAll('.termo-item').forEach((termo, index) => {
                const termoId = index + 1;
                reportData.termos.push({
                    tipo: document.getElementById(`termo_tipo_${termoId}`).value,
                    numero: document.getElementById(`termo_numero_${termoId}`).value
                });
            });
            
            document.querySelectorAll('.infrator-item').forEach((infrator, index) => {
                const infratorId = index + 1;
                reportData.infratores.push({
                    nome: document.getElementById(`infrator_nome_${infratorId}`).value,
                    documento: document.getElementById(`infrator_documento_${infratorId}`).value,
                    endereco: document.getElementById(`infrator_endereco_${infratorId}`).value,
                    contato: document.getElementById(`infrator_contato_${infratorId}`).value
                });
            });
            
            document.querySelectorAll('.photo-item:not([style*="display: none"])').forEach(photo => {
                reportData.photos.push({
                    caption: photo.querySelector('.photo-caption').value,
                    coords: photo.querySelector('.photo-coords').value,
                    src: photo.querySelector('.photo-preview').src,
                    coordSource: photo.querySelector('.coord-source').textContent
                });
            });
            
            try {
                localStorage.setItem('ambientalReportData', JSON.stringify(reportData));
                alert('Dados salvos com sucesso!');
                generateQRCode();
            } catch (e) {
                if (e.name === 'QuotaExceededError') {
                    alert('O armazenamento está cheio. Não foi possível salvar os dados.');
                } else {
                    alert('Erro ao salvar dados: ' + e.message);
                }
            }
        }
        
        function loadData() {
            const savedData = localStorage.getItem('ambientalReportData');
            if (!savedData) {
                alert('Nenhum dado salvo encontrado.');
                return;
            }
            
            try {
                const reportData = JSON.parse(savedData);
                
                document.getElementById('autos-container').innerHTML = '';
                document.getElementById('termos-container').innerHTML = '';
                document.getElementById('infratores-container').innerHTML = '';
                document.getElementById('photo-container').innerHTML = '';
                
                autoCount = 0;
                termoCount = 0;
                infratorCount = 0;
                photoCount = 0;
                
                document.getElementById('data').value = reportData.data || '';
                document.getElementById('hora').value = reportData.hora || '';
                document.getElementById('local').value = reportData.local || '';
                document.getElementById('latitude').value = reportData.latitude || '';
                document.getElementById('longitude').value = reportData.longitude || '';
                document.getElementById('descricao').value = reportData.descricao || '';
                document.getElementById('fiscal_nome').value = reportData.fiscal_nome || '';
                document.getElementById('fiscal_matricula').value = reportData.fiscal_matricula || '';
                
                if (reportData.signature) {
                    signaturePad.fromDataURL(reportData.signature);
                }
                
                if (reportData.latitude && reportData.longitude) {
                    updateDMSCoordinates(
                        parseFloat(reportData.latitude),
                        parseFloat(reportData.longitude)
                    );
                    
                    initMap(
                        parseFloat(reportData.latitude),
                        parseFloat(reportData.longitude)
                    );
                }
                
                if (reportData.autos && reportData.autos.length > 0) {
                    reportData.autos.forEach((auto, index) => {
                        if (index === 0) {
                            document.getElementById('auto_numero_1').value = auto.numero || '';
                            document.getElementById('auto_descricao_1').value = auto.descricao || '';
                            autoCount = 1;
                        } else {
                            addAuto();
                            const autoId = index + 1;
                            document.getElementById(`auto_numero_${autoId}`).value = auto.numero || '';
                            document.getElementById(`auto_descricao_${autoId}`).value = auto.descricao || '';
                        }
                    });
                }
                
                if (reportData.termos && reportData.termos.length > 0) {
                    reportData.termos.forEach((termo, index) => {
                        if (index === 0) {
                            document.getElementById('termo_tipo_1').value = termo.tipo || '';
                            document.getElementById('termo_numero_1').value = termo.numero || '';
                            termoCount = 1;
                        } else {
                            addTermo();
                            const termoId = index + 1;
                            document.getElementById(`termo_tipo_${termoId}`).value = termo.tipo || '';
                            document.getElementById(`termo_numero_${termoId}`).value = termo.numero || '';
                        }
                    });
                }
                
                if (reportData.infratores && reportData.infratores.length > 0) {
                    reportData.infratores.forEach((infrator, index) => {
                        if (index === 0) {
                            document.getElementById('infrator_nome_1').value = infrator.nome || '';
                            document.getElementById('infrator_documento_1').value = infrator.documento || '';
                            document.getElementById('infrator_endereco_1').value = infrator.endereco || '';
                            document.getElementById('infrator_contato_1').value = infrator.contato || '';
                            infratorCount = 1;
                        } else {
                            addInfrator();
                            const infratorId = index + 1;
                            document.getElementById(`infrator_nome_${infratorId}`).value = infrator.nome || '';
                            document.getElementById(`infrator_documento_${infratorId}`).value = infrator.documento || '';
                            document.getElementById(`infrator_endereco_${infratorId}`).value = infrator.endereco || '';
                            document.getElementById(`infrator_contato_${infratorId}`).value = infrator.contato || '';
                        }
                    });
                }
                
                if (reportData.photos && reportData.photos.length > 0) {
                    reportData.photos.forEach(photo => {
                        if (photo.src) {
                            photoCount++;
                            const photoContainer = document.getElementById('photo-container');
                            const template = photoContainer.querySelector('.photo-item');
                            const newPhoto = template.cloneNode(true);
                            
                            newPhoto.style.display = 'block';
                            newPhoto.querySelector('.photo-number').textContent = `Figura ${photoCount}`;
                            newPhoto.querySelector('.photo-preview').src = photo.src;
                            newPhoto.querySelector('.photo-caption').value = photo.caption || '';
                            newPhoto.querySelector('.photo-coords').value = photo.coords || '';
                            newPhoto.querySelector('.coord-source').textContent = photo.coordSource || '';
                            
                            newPhoto.querySelector('.remove-photo').addEventListener('click', function() {
                                photoContainer.removeChild(newPhoto);
                                updatePhotoNumbers();
                            });
                            
                            photoContainer.appendChild(newPhoto);
                        }
                    });
                }
                
                alert('Dados carregados com sucesso!');
                generateQRCode();
            } catch (e) {
                alert('Erro ao carregar dados: ' + e.message);
            }
        }
        
        function validateForm() {
            const requiredFields = [
                'data', 'hora', 'local', 'latitude', 'longitude',
                'descricao', 'fiscal_nome', 'fiscal_matricula'
            ];
            
            for (const fieldId of requiredFields) {
                const field = document.getElementById(fieldId);
                if (!field.value.trim()) {
                    field.focus();
                    return false;
                }
            }
            
            let hasAuto = false;
            document.querySelectorAll('.auto-numero').forEach(auto => {
                if (auto.value.trim()) hasAuto = true;
            });
            
            if (!hasAuto) {
                alert('Pelo menos um auto de infração deve ser preenchido.');
                return false;
            }
            
            let hasInfrator = false;
            document.querySelectorAll('.infrator-nome').forEach(infrator => {
                if (infrator.value.trim()) hasInfrator = true;
            });
            
            if (!hasInfrator) {
                alert('Pelo menos um infrator deve ser preenchido.');
                return false;
            }
            
            if (signaturePad.isEmpty()) {
                alert('Por favor, forneça sua assinatura.');
                return false;
            }
            
            return true;
        }
    </script>
</body>
</html>
