<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Relatório Fotográfico Ambiental 4.0</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary-color: #006400;
            --secondary-color: #4a8c4a;
            --accent-color: #8fbc8f;
            --danger-color: #dc3545;
            --warning-color: #ffc107;
            --info-color: #17a2b8;
            --light-color: #f8f9fa;
            --dark-color: #343a40;
            --text-color: #212529;
            --border-color: #dee2e6;
        }
        
        body {
            font-family: 'Segoe UI', Arial, sans-serif;
            margin: 0;
            padding: 0;
            line-height: 1.6;
            color: var(--text-color);
            background-color: #f5f5f5;
            display: flex;
            min-height: 100vh;
        }
        
        /* Menu lateral */
        .sidebar {
            width: 250px;
            background-color: var(--primary-color);
            color: white;
            padding: 20px 0;
            transition: all 0.3s;
            position: relative;
            z-index: 100;
        }
        
        .sidebar-header {
            padding: 0 20px 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .sidebar-menu {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        
        .sidebar-menu li {
            position: relative;
        }
        
        .sidebar-menu a {
            display: block;
            padding: 12px 20px;
            color: white;
            text-decoration: none;
            transition: all 0.3s;
        }
        
        .sidebar-menu a:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }
        
        .sidebar-menu a i {
            margin-right: 10px;
            width: 20px;
            text-align: center;
        }
        
        .sidebar-menu .active {
            background-color: rgba(255, 255, 255, 0.2);
        }
        
        /* Conteúdo principal */
        .main-content {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
        }
        
        .container {
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            background-color: white;
            border-radius: 5px;
            box-shadow: 0 0 15px rgba(0, 0, 0, 0.1);
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid var(--primary-color);
        }
        
        h1, h2, h3 {
            color: var(--primary-color);
        }
        
        h1 {
            font-size: 28px;
            margin-bottom: 10px;
        }
        
        h2 {
            font-size: 22px;
            margin-top: 30px;
            margin-bottom: 15px;
            padding-bottom: 8px;
            border-bottom: 1px solid var(--border-color);
            cursor: pointer;
        }
        
        h2:hover {
            color: var(--secondary-color);
        }
        
        h2 i {
            margin-right: 10px;
            transition: transform 0.3s;
        }
        
        h2.collapsed i {
            transform: rotate(-90deg);
        }
        
        .form-section {
            margin-bottom: 30px;
            page-break-inside: avoid;
            break-inside: avoid;
            transition: all 0.3s;
        }
        
        .collapsed-section {
            height: 0;
            overflow: hidden;
            margin-bottom: 0;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        label {
            display: block;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        input, textarea, select {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            box-sizing: border-box;
            font-family: inherit;
            font-size: 14px;
        }
        
        input:focus, textarea:focus, select:focus {
            border-color: var(--primary-color);
            outline: none;
            box-shadow: 0 0 0 3px rgba(0, 100, 0, 0.1);
        }
        
        #map {
            height: 400px;
            width: 100%;
            margin: 15px 0;
            border: 1px solid var(--border-color);
            border-radius: 4px;
        }
        
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 10px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin-top: 10px;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s;
        }
        
        .btn i {
            margin-right: 8px;
        }
        
        .btn-primary {
            background-color: var(--primary-color);
            color: white;
        }
        
        .btn-primary:hover {
            background-color: var(--secondary-color);
        }
        
        .btn-secondary {
            background-color: var(--secondary-color);
            color: white;
        }
        
        .btn-secondary:hover {
            background-color: var(--accent-color);
        }
        
        .btn-danger {
            background-color: var(--danger-color);
            color: white;
        }
        
        .btn-danger:hover {
            background-color: #c82333;
        }
        
        .coordinates {
            display: flex;
            gap: 15px;
        }
        
        .coord-input {
            flex: 1;
        }
        
        .error {
            color: var(--danger-color);
            margin-top: 5px;
            font-size: 13px;
        }
        
        .photo-container {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-top: 15px;
            page-break-inside: avoid;
            break-inside: avoid;
        }
        
        .photo-item {
            flex: 1 1 300px;
            border: 1px solid var(--border-color);
            padding: 10px;
            border-radius: 5px;
            position: relative;
            page-break-inside: avoid;
            break-inside: avoid;
            background-color: white;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
        }
        
        .photo-number {
            position: absolute;
            top: 5px;
            left: 5px;
            background-color: rgba(0, 100, 0, 0.7);
            color: white;
            padding: 3px 8px;
            border-radius: 3px;
            font-weight: bold;
            font-size: 12px;
        }
        
        .photo-preview {
            width: 100%;
            height: 200px;
            object-fit: cover;
            background-color: #f5f5f5;
            margin-bottom: 10px;
            border-radius: 3px;
        }
        
        .datetime-group {
            display: flex;
            gap: 15px;
        }
        
        .datetime-input {
            flex: 1;
        }
        
        .dms-coordinates {
            font-family: monospace;
            background-color: #f5f5f5;
            padding: 8px;
            border-radius: 3px;
            font-size: 14px;
        }
        
        .action-buttons {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 20px;
            flex-wrap: wrap;
        }
        
        .connection-status {
            position: fixed;
            top: 10px;
            right: 10px;
            padding: 5px 10px;
            border-radius: 4px;
            color: white;
            font-weight: bold;
            z-index: 1000;
            font-size: 12px;
            display: flex;
            align-items: center;
        }
        
        .connection-status i {
            margin-right: 5px;
        }
        
        .online {
            background-color: var(--primary-color);
        }
        
        .offline {
            background-color: var(--danger-color);
        }
        
        .footer {
            text-align: center;
            margin-top: 30px;
            padding-top: 15px;
            border-top: 1px solid var(--border-color);
            font-size: 0.9em;
            color: #666;
        }
        
        .termo-item, .auto-item, .infrator-item {
            border: 1px solid var(--border-color);
            padding: 15px;
            margin-bottom: 15px;
            border-radius: 4px;
            page-break-inside: avoid;
            break-inside: avoid;
            background-color: #f9f9f9;
        }
        
        .add-btn {
            margin-bottom: 15px;
        }
        
        #signature-pad {
            border: 1px solid var(--border-color);
            border-radius: 4px;
            background-color: white;
            width: 100%;
            touch-action: none;
        }
        
        .signature-clear {
            margin-top: 10px;
        }
        
        #qrcode {
            margin: 15px 0;
            text-align: center;
        }
        
        .alert {
            padding: 12px 15px;
            margin-bottom: 15px;
            border-radius: 4px;
            font-size: 14px;
        }
        
        .alert-warning {
            background-color: #fff3cd;
            color: #856404;
            border: 1px solid #ffeeba;
        }
        
        .alert-info {
            background-color: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        
        .page-break {
            page-break-after: always;
            break-after: page;
        }
        
        .avoid-break {
            page-break-inside: avoid;
            break-inside: avoid;
        }
        
        .coord-source {
            font-size: 0.8em;
            color: #666;
            font-style: italic;
            margin-top: 5px;
        }
        
        .infrator-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .infrator-title {
            font-weight: bold;
            color: var(--primary-color);
        }
        
        .remove-infrator {
            background-color: var(--danger-color);
            color: white;
            border: none;
            border-radius: 3px;
            padding: 5px 10px;
            cursor: pointer;
            font-size: 12px;
        }
        
        .remove-infrator:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }
        
        /* Progress bar */
        .progress-container {
            margin-bottom: 20px;
            background-color: #f1f1f1;
            border-radius: 4px;
            height: 20px;
            overflow: hidden;
        }
        
        .progress-bar {
            height: 100%;
            background-color: var(--primary-color);
            width: 0;
            transition: width 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 12px;
            font-weight: bold;
        }
        
        /* Tooltip */
        .tooltip {
            position: relative;
            display: inline-block;
            margin-left: 5px;
        }
        
        .tooltip .tooltiptext {
            visibility: hidden;
            width: 200px;
            background-color: #555;
            color: #fff;
            text-align: center;
            border-radius: 6px;
            padding: 5px;
            position: absolute;
            z-index: 1;
            bottom: 125%;
            left: 50%;
            margin-left: -100px;
            opacity: 0;
            transition: opacity 0.3s;
            font-size: 12px;
            font-weight: normal;
        }
        
        .tooltip:hover .tooltiptext {
            visibility: visible;
            opacity: 1;
        }
        
        /* Responsividade */
        @media (max-width: 768px) {
            body {
                flex-direction: column;
            }
            
            .sidebar {
                width: 100%;
                height: auto;
                padding: 10px 0;
            }
            
            .sidebar-menu {
                display: flex;
                flex-wrap: wrap;
            }
            
            .sidebar-menu li {
                flex: 1 1 auto;
            }
            
            .sidebar-menu a {
                padding: 10px;
                text-align: center;
            }
            
            .sidebar-menu a i {
                margin-right: 0;
                display: block;
                margin-bottom: 5px;
            }
            
            .coordinates {
                flex-direction: column;
                gap: 10px;
            }
            
            .action-buttons {
                justify-content: center;
            }
        }
        
        /* Estilos específicos para impressão/PDF */
        @media print {
            .no-print {
                display: none !important;
            }
            
            body {
                margin: 0;
                padding: 0;
                font-size: 12pt;
                line-height: 1.3;
                background: none;
            }
            
            .sidebar {
                display: none;
            }
            
            .main-content {
                padding: 0;
            }
            
            .container {
                max-width: 100%;
                border: none;
                box-shadow: none;
                padding: 0;
            }
            
            .header {
                margin-bottom: 15pt;
                padding-bottom: 5pt;
            }
            
            h1 {
                font-size: 18pt;
                margin-bottom: 10pt;
            }
            
            h2 {
                font-size: 14pt;
                margin-top: 15pt;
                margin-bottom: 8pt;
            }
            
            .form-section {
                margin-bottom: 20pt;
            }
            
            .photo-item {
                page-break-inside: avoid;
                margin-bottom: 15pt;
            }
            
            .photo-preview {
                max-height: 250pt;
                height: auto;
            }
            
            #signature-pad {
                width: 100% !important;
                height: 80pt !important;
            }
            
            .footer {
                display: none;
            }
            
            /* Cabeçalho e rodapé das páginas */
            @page {
                size: A4;
                margin: 2cm 1.5cm 2cm 1.5cm;
                
                @top-center {
                    content: "Relatório Fotográfico Ambiental - ICMBio";
                    font-size: 10pt;
                    border-bottom: 1px solid var(--primary-color);
                    padding-bottom: 5pt;
                }
                
                @bottom-center {
                    content: "Página " counter(page) " de " counter(pages);
                    font-size: 10pt;
                    border-top: 1px solid var(--primary-color);
                    padding-top: 5pt;
                }
            }
        }
    </style>
</head>
<body>
    <!-- Menu Lateral -->
    <div class="sidebar">
        <div class="sidebar-header">
            <h3>Relatório Ambiental</h3>
            <p>Versão 4.0</p>
        </div>
        <ul class="sidebar-menu">
            <li><a href="#dados-relatorio" class="active"><i class="fas fa-file-alt"></i> Dados do Relatório</a></li>
            <li><a href="#infratores"><i class="fas fa-user-times"></i> Infratores</a></li>
            <li><a href="#mapa"><i class="fas fa-map-marked-alt"></i> Mapa</a></li>
            <li><a href="#autos"><i class="fas fa-gavel"></i> Autos de Infração</a></li>
            <li><a href="#termos"><i class="fas fa-file-signature"></i> Termos</a></li>
            <li><a href="#descricao"><i class="fas fa-align-left"></i> Descrição</a></li>
            <li><a href="#fotos"><i class="fas fa-camera"></i> Fotos</a></li>
            <li><a href="#assinatura"><i class="fas fa-signature"></i> Assinatura</a></li>
        </ul>
    </div>
    
    <!-- Conteúdo Principal -->
    <div class="main-content">
        <div id="connectionStatus" class="connection-status offline">
            <i class="fas fa-wifi"></i> Offline
        </div>
        
        <div id="storage-warning" class="alert alert-warning" style="display: none;">
            <i class="fas fa-exclamation-triangle"></i> Atenção: O armazenamento está quase cheio. Alguns dados podem não ser salvos.
        </div>
        
        <div id="progress-container" class="progress-container no-print">
            <div id="progress-bar" class="progress-bar">0%</div>
        </div>
        
        <div class="container" id="relatorio">
            <div class="header">
                <h1>Relatório Fotográfico Ambiental <small>Versão 4.0</small></h1>
                <p>Instituto Chico Mendes de Conservação da Biodiversidade - ICMBio</p>
                <div id="qrcode"></div>
            </div>
            
            <!-- Seção de Dados do Relatório -->
            <div class="form-section" id="dados-relatorio">
                <h2><i class="fas fa-file-alt"></i> Dados do Relatório</h2>
                
                <div class="datetime-group">
                    <div class="datetime-input">
                        <label for="data">Data:</label>
                        <input type="date" id="data" required>
                    </div>
                    <div class="datetime-input">
                        <label for="hora">Hora:</label>
                        <input type="time" id="hora" required>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="local">Local da Fiscalização:</label>
                    <input type="text" id="local" required>
                </div>
                
                <div class="form-group">
                    <label for="fiscal_nome">Nome do Fiscal:</label>
                    <input type="text" id="fiscal_nome" required>
                </div>
                
                <div class="form-group">
                    <label for="fiscal_matricula">Matrícula:</label>
                    <input type="text" id="fiscal_matricula" required>
                </div>
            </div>
            
            <!-- Seção de Infratores -->
            <div class="form-section" id="infratores">
                <h2><i class="fas fa-user-times"></i> Infratores</h2>
                <div id="infratores-container">
                    <div class="infrator-item">
                        <div class="infrator-header">
                            <span class="infrator-title">Infrator #1</span>
                            <button class="remove-infrator no-print" data-id="1" disabled>Remover</button>
                        </div>
                        <div class="form-group">
                            <label for="infrator_nome_1">Nome do Infrator:</label>
                            <input type="text" id="infrator_nome_1" class="infrator-nome" required>
                        </div>
                        <div class="form-group">
                            <label for="infrator_documento_1">CPF/CNPJ:</label>
                            <input type="text" id="infrator_documento_1" class="infrator-documento" required>
                            <small id="documento-error-1" class="error"></small>
                        </div>
                        <div class="form-group">
                            <label for="infrator_endereco_1">Endereço:</label>
                            <input type="text" id="infrator_endereco_1" class="infrator-endereco">
                        </div>
                        <div class="form-group">
                            <label for="infrator_contato_1">Contato:</label>
                            <input type="text" id="infrator_contato_1" class="infrator-contato">
                        </div>
                    </div>
                </div>
                <button id="add-infrator" class="btn btn-secondary add-btn no-print">
                    <i class="fas fa-plus"></i> Adicionar Infrator
                </button>
            </div>
            
            <!-- Seção do Mapa -->
            <div class="form-section" id="mapa">
                <h2><i class="fas fa-map-marked-alt"></i> Mapa e Coordenadas</h2>
                
                <div class="form-group">
                    <label>Coordenadas Geográficas (Graus Decimais):</label>
                    <div class="coordinates">
                        <input type="text" id="latitude" class="coord-input" placeholder="Latitude" readonly>
                        <input type="text" id="longitude" class="coord-input" placeholder="Longitude" readonly>
                    </div>
                    <div id="coord-error" class="error"></div>
                    <div class="form-group">
                        <input type="checkbox" id="rastreamento" checked>
                        <label for="rastreamento" style="display: inline;">Atualizar coordenadas automaticamente</label>
                    </div>
                </div>
                
                <div class="form-group">
                    <label>Coordenadas em Graus, Minutos e Segundos:</label>
                    <div id="dms-coordinates" class="dms-coordinates">Não disponível</div>
                </div>
                
                <div class="form-group">
                    <label>Endereço aproximado:</label>
                    <div id="endereco-aproximado" class="dms-coordinates">Não disponível</div>
                </div>
                
                <div class="buttons no-print">
                    <button id="get-location" class="btn btn-primary">
                        <i class="fas fa-location-arrow"></i> Obter Localização
                    </button>
                    <button id="manual-coords" class="btn btn-secondary">
                        <i class="fas fa-map-marker-alt"></i> Inserir Manualmente
                    </button>
                    <button id="export-kml" class="btn btn-secondary">
                        <i class="fas fa-file-export"></i> Exportar KML
                    </button>
                </div>
                
                <div id="map"></div>
            </div>
            
            <!-- Seção de Autos de Infração -->
            <div class="form-section" id="autos">
                <h2><i class="fas fa-gavel"></i> Autos de Infração</h2>
                <div id="autos-container">
                    <div class="auto-item">
                        <div class="form-group">
                            <label for="auto_numero_1">Número do Auto de Infração:</label>
                            <input type="text" id="auto_numero_1" class="auto-numero" required>
                        </div>
                        <div class="form-group">
                            <label for="auto_descricao_1">Descrição da Infração:</label>
                            <textarea id="auto_descricao_1" class="auto-descricao" rows="3" required></textarea>
                        </div>
                        <button class="btn btn-secondary remove-auto no-print" data-id="1" disabled>
                            <i class="fas fa-trash"></i> Remover Auto
                        </button>
                    </div>
                </div>
                <button id="add-auto" class="btn btn-secondary add-btn no-print">
                    <i class="fas fa-plus"></i> Adicionar Auto
                </button>
            </div>
            
            <!-- Seção de Termos -->
            <div class="form-section" id="termos">
                <h2><i class="fas fa-file-signature"></i> Termos</h2>
                <div id="termos-container">
                    <div class="termo-item">
                        <div class="form-group">
                            <label for="termo_tipo_1">Tipo de Termo:</label>
                            <select id="termo_tipo_1" class="termo-tipo" required>
                                <option value="">Selecione...</option>
                                <option value="notificacao">Termo de Notificação</option>
                                <option value="apreensao">Termo de Apreensão</option>
                                <option value="embargo">Termo de Embargo</option>
                                <option value="soltura">Termo de Soltura</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="termo_numero_1">Número do Termo:</label>
                            <input type="text" id="termo_numero_1" class="termo-numero" required>
                        </div>
                        <button class="btn btn-secondary remove-termo no-print" data-id="1" disabled>
                            <i class="fas fa-trash"></i> Remover Termo
                        </button>
                    </div>
                </div>
                <button id="add-termo" class="btn btn-secondary add-btn no-print">
                    <i class="fas fa-plus"></i> Adicionar Termo
                </button>
            </div>
            
            <!-- Seção de Descrição -->
            <div class="form-section" id="descricao">
                <h2><i class="fas fa-align-left"></i> Descrição da Ação</h2>
                <div class="form-group">
                    <label for="descricao">Descrição detalhada do que foi realizado em campo:</label>
                    <textarea id="descricao" rows="6" required></textarea>
                </div>
                
                <div class="form-group no-print">
                    <button id="generate-summary" class="btn btn-secondary">
                        <i class="fas fa-magic"></i> Gerar Resumo Automático
                    </button>
                </div>
                
                <div class="form-group">
                    <label for="resumo">Resumo Executivo:</label>
                    <textarea id="resumo" rows="3" placeholder="Resumo conciso da ação..."></textarea>
                </div>
            </div>
            
            <!-- Seção de Fotos -->
            <div class="form-section" id="fotos">
                <h2><i class="fas fa-camera"></i> Registro Fotográfico</h2>
                
                <div class="form-group no-print">
                    <label for="photo-upload">Adicionar Fotos:</label>
                    <input type="file" id="photo-upload" accept="image/*" multiple>
                    <small>Selecione uma ou mais fotos para upload (com geolocalização preferencialmente)</small>
                </div>
                
                <div id="photo-container" class="photo-container">
                    <!-- Template para novas fotos -->
                    <div class="photo-item" style="display: none;">
                        <div class="photo-number">Figura 1</div>
                        <img class="photo-preview" src="" loading="lazy">
                        <div class="form-group">
                            <label>Legenda:</label>
                            <input type="text" class="photo-caption" placeholder="Descreva a foto">
                        </div>
                        <div class="form-group">
                            <label>Coordenadas:</label>
                            <input type="text" class="photo-coords" readonly>
                            <div class="coord-source"></div>
                        </div>
                        <button class="btn btn-secondary remove-photo no-print">
                            <i class="fas fa-trash"></i> Remover
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Seção de Assinatura -->
            <div class="form-section" id="assinatura">
                <h2><i class="fas fa-signature"></i> Assinatura do Fiscal</h2>
                <div class="form-group">
                    <label for="fiscal_nome">Nome do Fiscal:</label>
                    <input type="text" id="fiscal_nome" required>
                </div>
                <div class="form-group">
                    <label for="fiscal_matricula">Matrícula:</label>
                    <input type="text" id="fiscal_matricula" required>
                </div>
                <div class="form-group">
                    <label>Assinatura:</label>
                    <canvas id="signature-pad" width="400" height="200"></canvas>
                    <button id="clear-signature" class="btn btn-secondary signature-clear no-print">
                        <i class="fas fa-eraser"></i> Limpar Assinatura
                    </button>
                </div>
            </div>
            
            <!-- Botões de Ação -->
            <div class="action-buttons no-print">
                <button id="print-report" class="btn btn-primary">
                    <i class="fas fa-print"></i> Imprimir Relatório
                </button>
                <button id="generate-pdf" class="btn btn-secondary">
                    <i class="fas fa-file-pdf"></i> Gerar PDF
                </button>
                <button id="generate-word" class="btn btn-secondary">
                    <i class="fas fa-file-word"></i> Gerar Word
                </button>
                <button id="generate-excel" class="btn btn-secondary">
                    <i class="fas fa-file-excel"></i> Gerar Excel
                </button>
                <button id="save-data" class="btn btn-secondary">
                    <i class="fas fa-save"></i> Salvar Dados
                </button>
                <button id="load-data" class="btn btn-secondary">
                    <i class="fas fa-folder-open"></i> Carregar Dados
                </button>
                <button id="clear-storage" class="btn btn-danger">
                    <i class="fas fa-trash"></i> Limpar Armazenamento
                </button>
                <button id="backup-data" class="btn btn-secondary">
                    <i class="fas fa-download"></i> Backup
                </button>
            </div>
            
            <div class="footer">
                <p>Todos os direitos reservados &copy; <span id="current-year"></span> - Iram Mendes Jr - Analista Ambiental - ICMBio</p>
                <p>Versão 4.0 - <span id="last-update">2023-11-15</span></p>
            </div>
        </div>
    </div>

    <!-- Bibliotecas JavaScript -->
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/signature_pad/1.5.3/signature_pad.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.1/build/qrcode.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/exif-js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <script src="https://unpkg.com/docx@7.8.2/build/index.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/leaflet.offline@1.4.0/dist/leaflet.offline.min.js"></script>
    
    <script>
        // Variáveis globais
        let map;
        let marker;
        let signaturePad;
        let watchPositionId = null;
        let autoCount = 1;
        let termoCount = 1;
        let photoCount = 0;
        let infratorCount = 1;
        let isOnline = navigator.onLine;
        let photoMarkers = [];
        let storageWarningShown = false;
        
        // Chave para criptografia (em produção, isso deve ser mais seguro)
        const CRYPTO_KEY = "ICMBio@Ambiental2023";
        
        // Inicialização
        document.addEventListener('DOMContentLoaded', function() {
            // Configura data e hora atuais
            const now = new Date();
            document.getElementById('data').value = now.toISOString().split('T')[0];
            document.getElementById('hora').value = now.toTimeString().substring(0, 5);
            document.getElementById('current-year').textContent = now.getFullYear();
            document.getElementById('last-update').textContent = now.toISOString().split('T')[0];
            
            // Inicializa o mapa
            initMap(-15.788, -47.879);
            
            // Inicializa a área de assinatura
            const canvas = document.getElementById('signature-pad');
            signaturePad = new SignaturePad(canvas, {
                backgroundColor: 'rgba(255, 255, 255, 0)',
                penColor: 'rgb(0, 100, 0)'
            });
            
            // Configura eventos
            setupEventListeners();
            
            // Atualiza status da conexão
            updateConnectionStatus();
            
            // Gera QR Code inicial
            generateQRCode();
            
            // Verifica espaço de armazenamento
            checkStorageSpace();
            
            // Configura colapsar seções
            setupCollapsibleSections();
            
            // Atualiza barra de progresso
            updateProgressBar();
            
            // Configura tooltips
            setupTooltips();
        });
        
        // Configura os listeners de eventos
        function setupEventListeners() {
            // Botões de localização
            document.getElementById('get-location').addEventListener('click', getLocation);
            document.getElementById('manual-coords').addEventListener('click', manualCoords);
            document.getElementById('export-kml').addEventListener('click', exportToKML);
            
            // Botões de formulário
            document.getElementById('add-auto').addEventListener('click', addAuto);
            document.getElementById('add-termo').addEventListener('click', addTermo);
            document.getElementById('add-infrator').addEventListener('click', addInfrator);
            document.getElementById('generate-summary').addEventListener('click', generateSummary);
            
            // Upload de fotos
            document.getElementById('photo-upload').addEventListener('change', handlePhotoUpload);
            
            // Ações principais
            document.getElementById('print-report').addEventListener('click', printReport);
            document.getElementById('generate-pdf').addEventListener('click', generatePDF);
            document.getElementById('generate-word').addEventListener('click', generateWord);
            document.getElementById('generate-excel').addEventListener('click', generateExcel);
            document.getElementById('save-data').addEventListener('click', saveData);
            document.getElementById('load-data').addEventListener('click', loadData);
            document.getElementById('clear-signature').addEventListener('click', clearSignature);
            document.getElementById('clear-storage').addEventListener('click', clearStorage);
            document.getElementById('backup-data').addEventListener('click', backupData);
            
            // Validação de CPF/CNPJ
            document.querySelectorAll('.infrator-documento').forEach(input => {
                input.addEventListener('blur', validateDocument);
            });
            
            // Monitora mudanças na conexão
            window.addEventListener('online', updateConnectionStatus);
            window.addEventListener('offline', updateConnectionStatus);
            
            // Monitora mudanças no formulário para atualizar progresso
            document.querySelectorAll('input, textarea, select').forEach(element => {
                element.addEventListener('change', updateProgressBar);
                element.addEventListener('input', updateProgressBar);
            });
            
            // Atualiza endereço quando coordenadas mudam
            document.getElementById('latitude').addEventListener('change', reverseGeocode);
            document.getElementById('longitude').addEventListener('change', reverseGeocode);
        }
        
        function setupCollapsibleSections() {
            document.querySelectorAll('.form-section h2').forEach(header => {
                header.addEventListener('click', function() {
                    const section = this.parentElement;
                    section.classList.toggle('collapsed-section');
                    this.classList.toggle('collapsed');
                });
            });
        }
        
        function setupTooltips() {
            // Adiciona tooltips para campos importantes
            addTooltip('infrator_documento_1', 'Informe CPF (11 dígitos) ou CNPJ (14 dígitos)');
            addTooltip('photo-upload', 'Fotos com geolocalização serão posicionadas no mapa automaticamente');
            addTooltip('generate-summary', 'Gera um resumo automático baseado nos dados preenchidos');
        }
        
        function addTooltip(elementId, text) {
            const element = document.getElementById(elementId);
            if (element) {
                const tooltip = document.createElement('span');
                tooltip.className = 'tooltip';
                tooltip.innerHTML = '<i class="fas fa-info-circle"></i>';
                
                const tooltipText = document.createElement('span');
                tooltipText.className = 'tooltiptext';
                tooltipText.textContent = text;
                
                tooltip.appendChild(tooltipText);
                element.parentNode.insertBefore(tooltip, element.nextSibling);
            }
        }
        
        // Funções do mapa e geolocalização
        function initMap(lat, lng) {
            if (map) {
                map.setView([lat, lng], 15);
                if (marker) {
                    marker.setLatLng([lat, lng]);
                }
                return;
            }
            
            map = L.map('map').setView([lat, lng], 15);
            
            // Camadas base
            const streetLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
                maxZoom: 19
            });
            
            const satelliteLayer = L.tileLayer('https://mt1.google.com/vt/lyrs=s&x={x}&y={y}&z={z}', {
                attribution: 'Imagens © Google Satellite',
                maxZoom: 20
            });
            
            // Adiciona camada padrão
            if (isOnline) {
                satelliteLayer.addTo(map);
            } else {
                // Tenta carregar tiles offline se disponíveis
                try {
                    const offlineLayer = L.tileLayer.offline('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                        attribution: 'Map data © OpenStreetMap contributors',
                        subdomains: 'abc',
                        minZoom: 0,
                        maxZoom: 19
                    });
                    
                    offlineLayer.addTo(map);
                } catch (e) {
                    document.getElementById('map').innerHTML = 
                        '<p style="text-align: center; padding-top: 180px;">Mapa offline não disponível. Conecte-se à internet para carregar mapas.</p>';
                }
            }
            
            // Adiciona marcador
            marker = L.marker([lat, lng], { 
                draggable: true,
                title: 'Local da fiscalização'
            }).addTo(map);
            
            // Atualiza coordenadas quando o marcador é movido
            marker.on('dragend', function() {
                const newLatLng = marker.getLatLng();
                updateCoordinates(newLatLng.lat, newLatLng.lng);
                reverseGeocode();
            });
            
            // Atualiza coordenadas quando clica no mapa
            map.on('click', function(e) {
                updateCoordinates(e.latlng.lat, e.latlng.lng);
                if (!marker) {
                    marker = L.marker(e.latlng, { draggable: true }).addTo(map);
                    marker.on('dragend', function() {
                        const newLatLng = marker.getLatLng();
                        updateCoordinates(newLatLng.lat, newLatLng.lng);
                    });
                } else {
                    marker.setLatLng(e.latlng);
                }
                reverseGeocode();
            });
        }
        
        function getLocation() {
            const coordError = document.getElementById('coord-error');
            coordError.textContent = 'Obtendo localização...';
            
            if (!navigator.geolocation) {
                coordError.textContent = 'Geolocalização não é suportada pelo seu navegador';
                return;
            }
            
            // Para qualquer rastreamento anterior
            if (watchPositionId) {
                navigator.geolocation.clearWatch(watchPositionId);
            }
            
            const rastreamentoAtivo = document.getElementById('rastreamento').checked;
            
            if (rastreamentoAtivo) {
                // Rastreamento contínuo
                watchPositionId = navigator.geolocation.watchPosition(
                    position => {
                        const lat = position.coords.latitude;
                        const lng = position.coords.longitude;
                        updateCoordinates(lat, lng);
                        initMap(lat, lng);
                        coordError.textContent = 'Rastreamento ativo - coordenadas atualizadas';
                        reverseGeocode();
                    },
                    error => {
                        handleGeolocationError(error);
                    },
                    { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
                );
            } else {
                // Única leitura
                navigator.geolocation.getCurrentPosition(
                    position => {
                        const lat = position.coords.latitude;
                        const lng = position.coords.longitude;
                        updateCoordinates(lat, lng);
                        initMap(lat, lng);
                        coordError.textContent = '';
                        reverseGeocode();
                    },
                    error => {
                        handleGeolocationError(error);
                    },
                    { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
                );
            }
        }
        
        function handleGeolocationError(error) {
            const coordError = document.getElementById('coord-error');
            let errorMessage;
            
            switch(error.code) {
                case error.PERMISSION_DENIED:
                    errorMessage = "Permissão de localização negada pelo usuário";
                    break;
                case error.POSITION_UNAVAILABLE:
                    errorMessage = "Informações de localização indisponíveis";
                    break;
                case error.TIMEOUT:
                    errorMessage = "Tempo limite para obter localização excedido";
                    break;
                default:
                    errorMessage = "Ocorreu um erro desconhecido";
            }
            
            coordError.textContent = "Erro: " + errorMessage;
        }
        
        function manualCoords() {
            const lat = prompt("Digite a latitude (ex: -15.788):");
            const lng = prompt("Digite a longitude (ex: -47.879):");
            
            if (lat && lng && !isNaN(lat) && !isNaN(lng)) {
                updateCoordinates(parseFloat(lat), parseFloat(lng));
                initMap(parseFloat(lat), parseFloat(lng));
                reverseGeocode();
            } else {
                alert("Coordenadas inválidas. Por favor, insira valores numéricos.");
            }
        }
        
        function updateCoordinates(lat, lng) {
            document.getElementById('latitude').value = lat.toFixed(6);
            document.getElementById('longitude').value = lng.toFixed(6);
            updateDMSCoordinates(lat, lng);
            document.getElementById('coord-error').textContent = '';
        }
        
        function decimalToDMS(decimal, isLatitude) {
            const absDecimal = Math.abs(decimal);
            const degrees = Math.floor(absDecimal);
            const minutesNotTruncated = (absDecimal - degrees) * 60;
            const minutes = Math.floor(minutesNotTruncated);
            const seconds = ((minutesNotTruncated - minutes) * 60).toFixed(2);
            
            const direction = isLatitude 
                ? (decimal >= 0 ? 'N' : 'S') 
                : (decimal >= 0 ? 'E' : 'W');
            
            return `${degrees}° ${minutes}' ${seconds}" ${direction}`;
        }
        
        function updateDMSCoordinates(lat, lng) {
            const latDMS = decimalToDMS(lat, true);
            const lngDMS = decimalToDMS(lng, false);
            document.getElementById('dms-coordinates').textContent = 
                `Latitude: ${latDMS} | Longitude: ${lngDMS}`;
        }
        
        function reverseGeocode() {
            if (!isOnline) {
                document.getElementById('endereco-aproximado').textContent = "Geocodificação requer conexão com a internet";
                return;
            }
            
            const lat = document.getElementById('latitude').value;
            const lng = document.getElementById('longitude').value;
            
            if (!lat || !lng || isNaN(lat) || isNaN(lng)) {
                return;
            }
            
            fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}&zoom=18&addressdetails=1`)
                .then(response => response.json())
                .then(data => {
                    let address = '';
                    if (data.address) {
                        if (data.address.road) address += data.address.road + ', ';
                        if (data.address.village) address += data.address.village + ', ';
                        if (data.address.city) address += data.address.city + ', ';
                        if (data.address.state) address += data.address.state;
                        
                        if (address.endsWith(', ')) {
                            address = address.substring(0, address.length - 2);
                        }
                        
                        document.getElementById('endereco-aproximado').textContent = address || "Endereço não disponível";
                    } else {
                        document.getElementById('endereco-aproximado').textContent = "Endereço não encontrado";
                    }
                })
                .catch(error => {
                    console.error("Erro na geocodificação reversa:", error);
                    document.getElementById('endereco-aproximado').textContent = "Erro ao obter endereço";
                });
        }
        
        function exportToKML() {
            const lat = document.getElementById('latitude').value;
            const lng = document.getElementById('longitude').value;
            
            if (!lat || !lng || isNaN(lat) || isNaN(lng)) {
                alert("Coordenadas inválidas para exportar KML");
                return;
            }
            
            const placeName = document.getElementById('local').value || "Local da Fiscalização";
            const date = document.getElementById('data').value || new Date().toISOString().split('T')[0];
            
            const kmlContent = `<?xml version="1.0" encoding="UTF-8"?>
<kml xmlns="http://www.opengis.net/kml/2.2">
  <Document>
    <name>${placeName}</name>
    <description>Relatório Fotográfico Ambiental - ${date}</description>
    <Placemark>
      <name>${placeName}</name>
      <description>Local da fiscalização ambiental</description>
      <Point>
        <coordinates>${lng},${lat},0</coordinates>
      </Point>
    </Placemark>
  </Document>
</kml>`;
            
            const blob = new Blob([kmlContent], { type: 'application/vnd.google-earth.kml+xml' });
            saveAs(blob, `fiscalizacao_${date.replace(/-/g, '')}.kml`);
        }
        
        // Funções para adicionar elementos dinâmicos
        function addAuto() {
            autoCount++;
            const newAuto = document.createElement('div');
            newAuto.className = 'auto-item';
            newAuto.innerHTML = `
                <div class="form-group">
                    <label for="auto_numero_${autoCount}">Número do Auto de Infração:</label>
                    <input type="text" id="auto_numero_${autoCount}" class="auto-numero" required>
                </div>
                <div class="form-group">
                    <label for="auto_descricao_${autoCount}">Descrição da Infração:</label>
                    <textarea id="auto_descricao_${autoCount}" class="auto-descricao" rows="3" required></textarea>
                </div>
                <button class="btn btn-secondary remove-auto no-print" data-id="${autoCount}">
                    <i class="fas fa-trash"></i> Remover Auto
                </button>
            `;
            document.getElementById('autos-container').appendChild(newAuto);
            
            newAuto.querySelector('.remove-auto').addEventListener('click', function() {
                if (autoCount > 1) {
                    document.getElementById('autos-container').removeChild(newAuto);
                    autoCount--;
                    updateProgressBar();
                } else {
                    alert("Pelo menos um auto de infração deve ser mantido.");
                }
            });
            
            // Adiciona listeners para atualizar progresso
            newAuto.querySelector('.auto-numero').addEventListener('change', updateProgressBar);
            newAuto.querySelector('.auto-descricao').addEventListener('change', updateProgressBar);
        }
        
        function addTermo() {
            termoCount++;
            const newTermo = document.createElement('div');
            newTermo.className = 'termo-item';
            newTermo.innerHTML = `
                <div class="form-group">
                    <label for="termo_tipo_${termoCount}">Tipo de Termo:</label>
                    <select id="termo_tipo_${termoCount}" class="termo-tipo" required>
                        <option value="">Selecione...</option>
                        <option value="notificacao">Termo de Notificação</option>
                        <option value="apreensao">Termo de Apreensão</option>
                        <option value="embargo">Termo de Embargo</option>
                        <option value="soltura">Termo de Soltura</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="termo_numero_${termoCount}">Número do Termo:</label>
                    <input type="text" id="termo_numero_${termoCount}" class="termo-numero" required>
                </div>
                <button class="btn btn-secondary remove-termo no-print" data-id="${termoCount}">
                    <i class="fas fa-trash"></i> Remover Termo
                </button>
            `;
            document.getElementById('termos-container').appendChild(newTermo);
            
            newTermo.querySelector('.remove-termo').addEventListener('click', function() {
                if (termoCount > 1) {
                    document.getElementById('termos-container').removeChild(newTermo);
                    termoCount--;
                    updateProgressBar();
                } else {
                    alert("Pelo menos um termo deve ser mantido.");
                }
            });
            
            // Adiciona listeners para atualizar progresso
            newTermo.querySelector('.termo-tipo').addEventListener('change', updateProgressBar);
            newTermo.querySelector('.termo-numero').addEventListener('change', updateProgressBar);
        }
        
        function addInfrator() {
            infratorCount++;
            const newInfrator = document.createElement('div');
            newInfrator.className = 'infrator-item';
            newInfrator.innerHTML = `
                <div class="infrator-header">
                    <span class="infrator-title">Infrator #${infratorCount}</span>
                    <button class="remove-infrator no-print" data-id="${infratorCount}">Remover</button>
                </div>
                <div class="form-group">
                    <label for="infrator_nome_${infratorCount}">Nome do Infrator:</label>
                    <input type="text" id="infrator_nome_${infratorCount}" class="infrator-nome" required>
                </div>
                <div class="form-group">
                    <label for="infrator_documento_${infratorCount}">CPF/CNPJ:</label>
                    <input type="text" id="infrator_documento_${infratorCount}" class="infrator-documento" required>
                    <small id="documento-error-${infratorCount}" class="error"></small>
                </div>
                <div class="form-group">
                    <label for="infrator_endereco_${infratorCount}">Endereço:</label>
                    <input type="text" id="infrator_endereco_${infratorCount}" class="infrator-endereco">
                </div>
                <div class="form-group">
                    <label for="infrator_contato_${infratorCount}">Contato:</label>
                    <input type="text" id="infrator_contato_${infratorCount}" class="infrator-contato">
                </div>
            `;
            document.getElementById('infratores-container').appendChild(newInfrator);
            
            newInfrator.querySelector('.remove-infrator').addEventListener('click', function() {
                if (infratorCount > 1) {
                    document.getElementById('infratores-container').removeChild(newInfrator);
                    infratorCount--;
                    updateProgressBar();
                }
            });
            
            // Adiciona validação de CPF/CNPJ
            newInfrator.querySelector('.infrator-documento').addEventListener('blur', validateDocument);
            
            // Adiciona listeners para atualizar progresso
            newInfrator.querySelector('.infrator-nome').addEventListener('change', updateProgressBar);
            newInfrator.querySelector('.infrator-documento').addEventListener('change', updateProgressBar);
        }
        
        function validateDocument(e) {
            const input = e.target;
            const value = input.value.replace(/\D/g, '');
            const errorElement = document.getElementById(`documento-error-${input.id.split('_')[2]}`);
            
            if (value.length === 11) {
                // Valida CPF
                if (!validateCPF(value)) {
                    errorElement.textContent = "CPF inválido";
                    input.classList.add('error-border');
                } else {
                    errorElement.textContent = "";
                    input.classList.remove('error-border');
                }
            } else if (value.length === 14) {
                // Valida CNPJ
                if (!validateCNPJ(value)) {
                    errorElement.textContent = "CNPJ inválido";
                    input.classList.add('error-border');
                } else {
                    errorElement.textContent = "";
                    input.classList.remove('error-border');
                }
            } else if (value.length > 0) {
                errorElement.textContent = "Documento deve ter 11 (CPF) ou 14 (CNPJ) dígitos";
                input.classList.add('error-border');
            } else {
                errorElement.textContent = "";
                input.classList.remove('error-border');
            }
        }
        
        function validateCPF(cpf) {
            cpf = cpf.replace(/\D/g, '');
            if (cpf.length !== 11 || /^(\d)\1{10}$/.test(cpf)) return false;
            
            let sum = 0;
            for (let i = 0; i < 9; i++) {
                sum += parseInt(cpf.charAt(i)) * (10 - i);
            }
            let remainder = (sum * 10) % 11;
            if (remainder === 10 || remainder === 11) remainder = 0;
            if (remainder !== parseInt(cpf.charAt(9))) return false;
            
            sum = 0;
            for (let i = 0; i < 10; i++) {
                sum += parseInt(cpf.charAt(i)) * (11 - i);
            }
            remainder = (sum * 10) % 11;
            if (remainder === 10 || remainder === 11) remainder = 0;
            if (remainder !== parseInt(cpf.charAt(10))) return false;
            
            return true;
        }
        
        function validateCNPJ(cnpj) {
            cnpj = cnpj.replace(/\D/g, '');
            if (cnpj.length !== 14 || /^(\d)\1{13}$/.test(cnpj)) return false;
            
            let length = cnpj.length - 2;
            let numbers = cnpj.substring(0, length);
            const digits = cnpj.substring(length);
            let sum = 0;
            let pos = length - 7;
            
            for (let i = length; i >= 1; i--) {
                sum += numbers.charAt(length - i) * pos--;
                if (pos < 2) pos = 9;
            }
            
            let result = sum % 11 < 2 ? 0 : 11 - sum % 11;
            if (result != digits.charAt(0)) return false;
            
            length = length + 1;
            numbers = cnpj.substring(0, length);
            sum = 0;
            pos = length - 7;
            
            for (let i = length; i >= 1; i--) {
                sum += numbers.charAt(length - i) * pos--;
                if (pos < 2) pos = 9;
            }
            
            result = sum % 11 < 2 ? 0 : 11 - sum % 11;
            if (result != digits.charAt(1)) return false;
            
            return true;
        }
        
        // Funções para manipulação de fotos
        function handlePhotoUpload(e) {
            const files = e.target.files;
            const defaultCoords = {
                lat: parseFloat(document.getElementById('latitude').value) || -15.788,
                lng: parseFloat(document.getElementById('longitude').value) || -47.879,
                fromExif: false
            };
            
            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                
                if (file.type.match('image.*')) {
                    const reader = new FileReader();
                    
                    reader.onload = function(e) {
                        EXIF.getData(file, function() {
                            const exifData = EXIF.getAllTags(this);
                            let coords = {...defaultCoords};
                            
                            if (exifData.GPSLatitude && exifData.GPSLongitude) {
                                coords = {
                                    lat: convertDMSToDD(
                                        exifData.GPSLatitude[0],
                                        exifData.GPSLatitude[1],
                                        exifData.GPSLatitude[2],
                                        exifData.GPSLatitudeRef
                                    ),
                                    lng: convertDMSToDD(
                                        exifData.GPSLongitude[0],
                                        exifData.GPSLongitude[1],
                                        exifData.GPSLongitude[2],
                                        exifData.GPSLongitudeRef
                                    ),
                                    fromExif: true
                                };
                            }
                            
                            addPhoto(file, coords);
                        });
                    };
                    reader.readAsDataURL(file);
                } else {
                    addPhoto(file, defaultCoords);
                }
            }
            
            e.target.value = '';
        }

        function convertDMSToDD(degrees, minutes, seconds, direction) {
            let dd = Number(degrees) + (Number(minutes) / 60) + (Number(seconds) / 3600);
            if (direction === 'S' || direction === 'W') {
                dd = dd * -1;
            }
            return dd;
        }
        
        function addPhoto(file, coords) {
            photoCount++;
            const photoContainer = document.getElementById('photo-container');
            const template = photoContainer.querySelector('.photo-item');
            const newPhoto = template.cloneNode(true);
            
            newPhoto.style.display = 'block';
            newPhoto.querySelector('.photo-number').textContent = `Figura ${photoCount}`;
            newPhoto.querySelector('.photo-preview').src = URL.createObjectURL(file);
            
            const coordSource = coords.fromExif ? 
                '(Coordenadas extraídas da foto)' : 
                '(Coordenadas do formulário)';
            
            newPhoto.querySelector('.photo-coords').value = 
                `${coords.lat.toFixed(6)}, ${coords.lng.toFixed(6)}`;
            newPhoto.querySelector('.coord-source').textContent = coordSource;
            
            newPhoto.querySelector('.photo-caption').placeholder = "Descreva a foto...";
            
            newPhoto.querySelector('.remove-photo').addEventListener('click', function() {
                photoContainer.removeChild(newPhoto);
                updatePhotoNumbers();
                removePhotoMarker(photoCount);
                updateProgressBar();
            });
            
            photoContainer.appendChild(newPhoto);
            
            // Adiciona marcador no mapa para a foto
            addPhotoMarker(coords.lat, coords.lng, photoCount);
            
            // Atualiza barra de progresso
            updateProgressBar();
        }
        
        function addPhotoMarker(lat, lng, number) {
            if (!map) return;
            
            const photoIcon = L.divIcon({
                className: 'photo-marker',
                html: `<div style="background-color: #006400; color: white; border-radius: 50%; width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; font-weight: bold;">${number}</div>`,
                iconSize: [24, 24],
                iconAnchor: [12, 12]
            });
            
            const marker = L.marker([lat, lng], {
                icon: photoIcon,
                title: `Foto ${number}`
            }).addTo(map);
            
            photoMarkers[number] = marker;
        }
        
        function removePhotoMarker(number) {
            if (photoMarkers[number]) {
                map.removeLayer(photoMarkers[number]);
                delete photoMarkers[number];
            }
        }
        
        function updatePhotoNumbers() {
            const photos = document.querySelectorAll('.photo-item:not([style*="display: none"])');
            photoCount = 0;
            
            photos.forEach((photo, index) => {
                photoCount++;
                photo.querySelector('.photo-number').textContent = `Figura ${photoCount}`;
                
                // Atualiza marcador no mapa
                const coords = photo.querySelector('.photo-coords').value;
                if (coords) {
                    const [lat, lng] = coords.split(',').map(coord => parseFloat(coord.trim()));
                    if (photoMarkers[index + 1]) {
                        photoMarkers[index + 1].setLatLng([lat, lng]);
                        photoMarkers[index + 1]._icon.innerHTML = `<div style="background-color: #006400; color: white; border-radius: 50%; width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; font-weight: bold;">${photoCount}</div>`;
                    }
                }
            });
        }
        
        // Funções de utilidade
        function clearSignature() {
            signaturePad.clear();
            updateProgressBar();
        }
        
        function clearStorage() {
            if (confirm('Tem certeza que deseja limpar todos os dados salvos?')) {
                localStorage.clear();
                alert('Armazenamento limpo com sucesso!');
                document.getElementById('storage-warning').style.display = 'none';
                storageWarningShown = false;
            }
        }
        
        function backupData() {
            const savedData = localStorage.getItem('ambientalReportData');
            if (!savedData) {
                alert('Nenhum dado salvo encontrado para backup.');
                return;
            }
            
            try {
                const blob = new Blob([savedData], { type: 'application/json' });
                const date = new Date().toISOString().split('T')[0];
                saveAs(blob, `backup_relatorio_ambiental_${date}.json`);
            } catch (e) {
                alert('Erro ao criar backup: ' + e.message);
            }
        }
        
        function printReport() {
            if (!validateForm()) {
                alert('Por favor, preencha todos os campos obrigatórios antes de imprimir.');
                return;
            }
            window.print();
        }
        
        function checkStorageSpace() {
            try {
                const testKey = 'storage_test';
                let data = '';
                for (let i = 0; i < 1024; i++) {
                    data += '1234567890';
                }
                
                localStorage.setItem(testKey, data);
                localStorage.removeItem(testKey);
                
                if (storageWarningShown) {
                    document.getElementById('storage-warning').style.display = 'none';
                    storageWarningShown = false;
                }
                
                return true;
            } catch (e) {
                if (e.name === 'QuotaExceededError') {
                    document.getElementById('storage-warning').style.display = 'block';
                    storageWarningShown = true;
                    return false;
                }
                return true;
            }
        }
        
        function updateConnectionStatus() {
            isOnline = navigator.onLine;
            const connectionStatus = document.getElementById('connectionStatus');
            
            if (isOnline) {
                connectionStatus.innerHTML = '<i class="fas fa-wifi"></i> Online';
                connectionStatus.className = 'connection-status online';
                
                if (!map) {
                    const lat = parseFloat(document.getElementById('latitude').value) || -15.788;
                    const lng = parseFloat(document.getElementById('longitude').value) || -47.879;
                    initMap(lat, lng);
                }
            } else {
                connectionStatus.innerHTML = '<i class="fas fa-wifi-slash"></i> Offline';
                connectionStatus.className = 'connection-status offline';
            }
        }
        
        function generateQRCode() {
            const qrElement = document.getElementById('qrcode');
            qrElement.innerHTML = '';
            
            const reportId = `REL-${document.getElementById('data').value}-${document.getElementById('auto_numero_1').value || '000'}`;
            
            QRCode.toCanvas(qrElement, reportId, { width: 150 }, function(error) {
                if (error) console.error('Erro ao gerar QR Code:', error);
            });
        }
        
        function blobToArrayBuffer(blob) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result);
                reader.onerror = reject;
                reader.readAsArrayBuffer(blob);
            });
        }
        
        function updateProgressBar() {
            const requiredFields = [
                'data', 'hora', 'local', 'latitude', 'longitude',
                'descricao', 'fiscal_nome', 'fiscal_matricula'
            ];
            
            let filledFields = 0;
            
            // Campos básicos
            for (const fieldId of requiredFields) {
                const field = document.getElementById(fieldId);
                if (field && field.value.trim()) {
                    filledFields++;
                }
            }
            
            // Autos de infração
            const autos = document.querySelectorAll('.auto-numero, .auto-descricao');
            autos.forEach(auto => {
                if (auto.value.trim()) filledFields += 0.5;
            });
            
            // Infratores
            const infratores = document.querySelectorAll('.infrator-nome, .infrator-documento');
            infratores.forEach(infrator => {
                if (infrator.value.trim()) filledFields += 0.5;
            });
            
            // Termos
            const termos = document.querySelectorAll('.termo-tipo, .termo-numero');
            termos.forEach(termo => {
                if (termo.value.trim()) filledFields += 0.5;
            });
            
            // Fotos
            const photos = document.querySelectorAll('.photo-item:not([style*="display: none"])');
            filledFields += photos.length * 0.2;
            
            // Assinatura
            if (!signaturePad.isEmpty()) filledFields++;
            
            // Calcula porcentagem (ajustada para o peso de cada seção)
            const totalWeight = requiredFields.length + (autos.length / 2) + (infratores.length / 2) + (termos.length / 2) + (photos.length * 0.2) + 1;
            const percentage = Math.min(Math.round((filledFields / totalWeight) * 100), 100);
            
            const progressBar = document.getElementById('progress-bar');
            progressBar.style.width = `${percentage}%`;
            progressBar.textContent = `${percentage}%`;
            
            // Muda a cor conforme o progresso
            if (percentage < 50) {
                progressBar.style.backgroundColor = '#dc3545';
            } else if (percentage < 80) {
                progressBar.style.backgroundColor = '#ffc107';
            } else {
                progressBar.style.backgroundColor = '#28a745';
            }
        }
        
        function generateSummary() {
            const infratores = [];
            document.querySelectorAll('.infrator-nome').forEach(infrator => {
                if (infrator.value.trim()) infratores.push(infrator.value.trim());
            });
            
            const autos = [];
            document.querySelectorAll('.auto-descricao').forEach(auto => {
                if (auto.value.trim()) autos.push(auto.value.trim());
            });
            
            const termos = [];
            document.querySelectorAll('.termo-tipo').forEach(termo => {
                if (termo.value.trim()) termos.push(termo.options[termo.selectedIndex].text);
            });
            
            const local = document.getElementById('local').value.trim();
            const data = document.getElementById('data').value;
            const hora = document.getElementById('hora').value;
            
            let summary = `Relatório de fiscalização ambiental realizada em ${local}, no dia ${formatDate(data)} às ${hora}. `;
            
            if (infratores.length > 0) {
                summary += `Foram identificados ${infratores.length} infrator(es): ${infratores.join(', ')}. `;
            }
            
            if (autos.length > 0) {
                summary += `Foram lavrados ${autos.length} auto(s) de infração. `;
            }
            
            if (termos.length > 0) {
                summary += `Foram elaborados os seguintes termos: ${termos.join(', ')}. `;
            }
            
            const photos = document.querySelectorAll('.photo-item:not([style*="display: none"])');
            if (photos.length > 0) {
                summary += `O registro fotográfico contém ${photos.length} imagem(ns) que documentam a ação.`;
            }
            
            document.getElementById('resumo').value = summary;
        }
        
        function formatDate(dateString) {
            const options = { day: '2-digit', month: 'long', year: 'numeric' };
            return new Date(dateString).toLocaleDateString('pt-BR', options);
        }
        
        // Funções de exportação (generatePDF, generateWord, generateExcel mantidas da versão anterior)
        // ... (manter as mesmas funções de exportação da versão anterior)
        
        // Funções de armazenamento (saveData, loadData mantidas da versão anterior, mas com criptografia)
        function encryptData(data) {
            return CryptoJS.AES.encrypt(JSON.stringify(data), CRYPTO_KEY).toString();
        }
        
        function decryptData(encryptedData) {
            try {
                const bytes = CryptoJS.AES.decrypt(encryptedData, CRYPTO_KEY);
                return JSON.parse(bytes.toString(CryptoJS.enc.Utf8));
            } catch (e) {
                console.error("Erro ao descriptografar dados:", e);
                return null;
            }
        }
        
        function saveData() {
            if (!validateForm()) {
                alert('Por favor, preencha todos os campos obrigatórios antes de salvar.');
                return;
            }
            
            if (!checkStorageSpace()) {
                alert('Armazenamento cheio. Não é possível salvar os dados.');
                return;
            }
            
            const reportData = {
                version: "4.0",
                data: document.getElementById('data').value,
                hora: document.getElementById('hora').value,
                local: document.getElementById('local').value,
                latitude: document.getElementById('latitude').value,
                longitude: document.getElementById('longitude').value,
                descricao: document.getElementById('descricao').value,
                resumo: document.getElementById('resumo').value,
                fiscal_nome: document.getElementById('fiscal_nome').value,
                fiscal_matricula: document.getElementById('fiscal_matricula').value,
                signature: signaturePad.isEmpty() ? null : signaturePad.toDataURL('image/png'),
                autos: [],
                termos: [],
                infratores: [],
                photos: []
            };
            
            document.querySelectorAll('.auto-item').forEach((auto, index) => {
                const autoId = index + 1;
                reportData.autos.push({
                    numero: document.getElementById(`auto_numero_${autoId}`).value,
                    descricao: document.getElementById(`auto_descricao_${autoId}`).value
                });
            });
            
            document.querySelectorAll('.termo-item').forEach((termo, index) => {
                const termoId = index + 1;
                reportData.termos.push({
                    tipo: document.getElementById(`termo_tipo_${termoId}`).value,
                    numero: document.getElementById(`termo_numero_${termoId}`).value
                });
            });
            
            document.querySelectorAll('.infrator-item').forEach((infrator, index) => {
                const infratorId = index + 1;
                reportData.infratores.push({
                    nome: document.getElementById(`infrator_nome_${infratorId}`).value,
                    documento: document.getElementById(`infrator_documento_${infratorId}`).value,
                    endereco: document.getElementById(`infrator_endereco_${infratorId}`).value,
                    contato: document.getElementById(`infrator_contato_${infratorId}`).value
                });
            });
            
            document.querySelectorAll('.photo-item:not([style*="display: none"])').forEach(photo => {
                reportData.photos.push({
                    caption: photo.querySelector('.photo-caption').value,
                    coords: photo.querySelector('.photo-coords').value,
                    src: photo.querySelector('.photo-preview').src,
                    coordSource: photo.querySelector('.coord-source').textContent
                });
            });
            
            try {
                const encryptedData = encryptData(reportData);
                localStorage.setItem('ambientalReportData', encryptedData);
                alert('Dados salvos com sucesso!');
                generateQRCode();
                updateProgressBar();
            } catch (e) {
                if (e.name === 'QuotaExceededError') {
                    alert('O armazenamento está cheio. Não foi possível salvar os dados.');
                } else {
                    alert('Erro ao salvar dados: ' + e.message);
                }
            }
        }
        
        function loadData() {
            const encryptedData = localStorage.getItem('ambientalReportData');
            if (!encryptedData) {
                alert('Nenhum dado salvo encontrado.');
                return;
            }
            
            const reportData = decryptData(encryptedData);
            if (!reportData) {
                alert('Erro ao carregar dados. Os dados podem estar corrompidos.');
                return;
            }
            
            try {
                // Verifica versão do formato dos dados
                if (!reportData.version || reportData.version !== "4.0") {
                    if (!confirm('Os dados salvos são de uma versão antiga. Deseja tentar carregá-los mesmo assim?')) {
                        return;
                    }
                }
                
                document.getElementById('autos-container').innerHTML = '';
                document.getElementById('termos-container').innerHTML = '';
                document.getElementById('infratores-container').innerHTML = '';
                document.getElementById('photo-container').innerHTML = '';
                
                autoCount = 0;
                termoCount = 0;
                infratorCount = 0;
                photoCount = 0;
                
                document.getElementById('data').value = reportData.data || '';
                document.getElementById('hora').value = reportData.hora || '';
                document.getElementById('local').value = reportData.local || '';
                document.getElementById('latitude').value = reportData.latitude || '';
                document.getElementById('longitude').value = reportData.longitude || '';
                document.getElementById('descricao').value = reportData.descricao || '';
                document.getElementById('resumo').value = reportData.resumo || '';
                document.getElementById('fiscal_nome').value = reportData.fiscal_nome || '';
                document.getElementById('fiscal_matricula').value = reportData.fiscal_matricula || '';
                
                if (reportData.signature) {
                    signaturePad.fromDataURL(reportData.signature);
                }
                
                if (reportData.latitude && reportData.longitude) {
                    updateDMSCoordinates(
                        parseFloat(reportData.latitude),
                        parseFloat(reportData.longitude)
                    );
                    
                    initMap(
                        parseFloat(reportData.latitude),
                        parseFloat(reportData.longitude)
                    );
                }
                
                if (reportData.autos && reportData.autos.length > 0) {
                    reportData.autos.forEach((auto, index) => {
                        if (index === 0) {
                            document.getElementById('auto_numero_1').value = auto.numero || '';
                            document.getElementById('auto_descricao_1').value = auto.descricao || '';
                            autoCount = 1;
                        } else {
                            addAuto();
                            const autoId = index + 1;
                            document.getElementById(`auto_numero_${autoId}`).value = auto.numero || '';
                            document.getElementById(`auto_descricao_${autoId}`).value = auto.descricao || '';
                        }
                    });
                }
                
                if (reportData.termos && reportData.termos.length > 0) {
                    reportData.termos.forEach((termo, index) => {
                        if (index === 0) {
                            document.getElementById('termo_tipo_1').value = termo.tipo || '';
                            document.getElementById('termo_numero_1').value = termo.numero || '';
                            termoCount = 1;
                        } else {
                            addTermo();
                            const termoId = index + 1;
                            document.getElementById(`termo_tipo_${termoId}`).value = termo.tipo || '';
                            document.getElementById(`termo_numero_${termoId}`).value = termo.numero || '';
                        }
                    });
                }
                
                if (reportData.infratores && reportData.infratores.length > 0) {
                    reportData.infratores.forEach((infrator, index) => {
                        if (index === 0) {
                            document.getElementById('infrator_nome_1').value = infrator.nome || '';
                            document.getElementById('infrator_documento_1').value = infrator.documento || '';
                            document.getElementById('infrator_endereco_1').value = infrator.endereco || '';
                            document.getElementById('infrator_contato_1').value = infrator.contato || '';
                            infratorCount = 1;
                        } else {
                            addInfrator();
                            const infratorId = index + 1;
                            document.getElementById(`infrator_nome_${infratorId}`).value = infrator.nome || '';
                            document.getElementById(`infrator_documento_${infratorId}`).value = infrator.documento || '';
                            document.getElementById(`infrator_endereco_${infratorId}`).value = infrator.endereco || '';
                            document.getElementById(`infrator_contato_${infratorId}`).value = infrator.contato || '';
                        }
                    });
                }
                
                if (reportData.photos && reportData.photos.length > 0) {
                    reportData.photos.forEach(photo => {
                        if (photo.src) {
                            photoCount++;
                            const photoContainer = document.getElementById('photo-container');
                            const template = photoContainer.querySelector('.photo-item');
                            const newPhoto = template.cloneNode(true);
                            
                            newPhoto.style.display = 'block';
                            newPhoto.querySelector('.photo-number').textContent = `Figura ${photoCount}`;
                            newPhoto.querySelector('.photo-preview').src = photo.src;
                            newPhoto.querySelector('.photo-caption').value = photo.caption || '';
                            newPhoto.querySelector('.photo-coords').value = photo.coords || '';
                            newPhoto.querySelector('.coord-source').textContent = photo.coordSource || '';
                            
                            newPhoto.querySelector('.remove-photo').addEventListener('click', function() {
                                photoContainer.removeChild(newPhoto);
                                updatePhotoNumbers();
                                removePhotoMarker(photoCount);
                                updateProgressBar();
                            });
                            
                            photoContainer.appendChild(newPhoto);
                            
                            // Adiciona marcador no mapa para a foto
                            if (photo.coords) {
                                const [lat, lng] = photo.coords.split(',').map(coord => parseFloat(coord.trim()));
                                addPhotoMarker(lat, lng, photoCount);
                            }
                        }
                    });
                }
                
                alert('Dados carregados com sucesso!');
                generateQRCode();
                updateProgressBar();
            } catch (e) {
                alert('Erro ao carregar dados: ' + e.message);
            }
        }
        
        function validateForm() {
            const requiredFields = [
                'data', 'hora', 'local', 'latitude', 'longitude',
                'descricao', 'fiscal_nome', 'fiscal_matricula'
            ];
            
            for (const fieldId of requiredFields) {
                const field = document.getElementById(fieldId);
                if (!field.value.trim()) {
                    field.focus();
                    return false;
                }
            }
            
            let hasAuto = false;
            document.querySelectorAll('.auto-numero').forEach(auto => {
                if (auto.value.trim()) hasAuto = true;
            });
            
            if (!hasAuto) {
                alert('Pelo menos um auto de infração deve ser preenchido.');
                return false;
            }
            
            let hasInfrator = false;
            document.querySelectorAll('.infrator-nome').forEach(infrator => {
                if (infrator.value.trim()) hasInfrator = true;
            });
            
            if (!hasInfrator) {
                alert('Pelo menos um infrator deve ser preenchido.');
                return false;
            }
            
            if (signaturePad.isEmpty()) {
                alert('Por favor, forneça sua assinatura.');
                return false;
            }
            
            return true;
        }
    </script>
</body>
</html>
